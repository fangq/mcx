<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="utf-8"/>
    <meta name="author" content="Qianqian Fang">
    <meta name="copyright" content="Qianqian Fang" />
    <meta name="license" content="GNU General Public License v3 or later" />
    <meta name="keywords" content="Monte Carlo,photon,tissue optics,MCX,Monte Carlo eXtreme,COTI,FangLab,MCX Cloud,Docker,JQuery,JSON,JSON Schema,JSON Editor,WebGL"/>
    <title>MCX Cloud - A Web-based Monte Carlo Photon Simulator</title>
    <script src="https://cdn.jsdelivr.net/npm/@json-editor/json-editor@latest/dist/jsoneditor.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/lz-string@1.4.4/libs/lz-string.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/three.js/0.145.0/three.min.js"></script>
    <script src="https://mcx.space/cloud/js/OrbitControls.js"></script>
    <script src="https://unpkg.com/load_avg@0.16.0/build/stats.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/numjs/0.16.0/numjs.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/pako/1.0.11/pako.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/require.js/2.3.6/require.min.js"></script>
    <script src="https://neurojson.org/js/jdata.js"></script>
    <link rel='stylesheet' id='theme-link'>
    <link rel='stylesheet' id='iconlib-link'>
    <style id=page_style>
      @page { size: 9in 7.5in ; margin : 0px }
    </style>

<!-- Global site tag (gtag.js) - Google Analytics -->
<script async src="https://www.googletagmanager.com/gtag/js?id=G-YHNSQJPJEW"></script>
<script>
  window.dataLayer = window.dataLayer || [];
  function gtag(){dataLayer.push(arguments);}
  gtag('js', new Date());

  gtag('config', 'G-YHNSQJPJEW');
</script>

</head>
<body>
<style type="text/css">
/* latin */
@font-face {
  font-family: 'Ubuntu';
  font-style: normal;
  font-weight: 500;
  src: local('Ubuntu Medium'), local('Ubuntu-Medium'), url('http://mcx.space/fonts/ubuntu-medium.woff2') format('woff2'),  url('http://mcx.space/fonts/ubuntu-medium.woff') format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}
@font-face {
  font-family: 'Ubuntu';
  font-style: normal;
  font-weight: 300;
  src: url('http://mcx.space/fonts/ubuntu-light.woff') format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}

@font-face {
  font-family: 'Ubuntu';
  font-style: bold;
  font-weight: 700;
  src: url('http://mcx.space/fonts/ubuntu-bold.woff') format('woff');
  unicode-range: U+0000-00FF, U+0131, U+0152-0153, U+02C6, U+02DA, U+02DC, U+2000-206F, U+2074, U+20AC, U+2212, U+2215, U+E0FF, U+EFFD, U+F000;
}

.sidenav {
  height: 100%;
  width: 0;
  position: fixed;
  z-index: 1;
  top: 0;
  left: 0;
  background-color: gray;
  overflow-x: hidden;
  transition: 0.5s;
  padding-top: 60px;
}

.sidenav .closebtn {
  position: absolute;
  top: 0;
  right: 25px;
  font-size: 36px;
  margin-left: 50px;
}

.tab-item {
  display: inline;
  min-width: 5em;
  font-size: 130%;
}
.longinput{
  width: 100%;
}
.shortinput{
  width: 24%;
}
#thumbnail{
  height: auto;
}
section {
    width: 100%;
    margin-left: 10px;
}
#site-navigation{
  float:none;
}

.col-md-8{
  display:none;
  width: 100%;
  padding: 0 4% 0 4%;
}

.active{
  display:block;
}
.nav {
  flex-direction: row;
}

.bigtab li{
  vertical-align: middle;
  text-align: center;
  width: 150px;
  font-size: 30px;
  margin-right: 2em;
}
.bigtab i{
  font-size: 150px;
  color: #7744d1;
}

.bigtab{
  width: 1000px;
  border-bottom: 0px;
}

#mcx1-run input{
  width:49%;
}
#shareinfo{
  float:left;
  width:60%;
  margin-right: 2em;
  min-width: 700px;
}
#previewinfo{
  float:left;
  width:35%;
}
#submitshare{
  overflow: hidden;
  width: 100%;
}
#canvas {
    background-color: #000;
    width: 937px;
    height: 750px;
    border: 1px solid black;
    padding: 0px;
}
#run-log, #output-textarea{
  height: 60vh;
}
#schema-textarea{
  height: 75vh;
}
.tab-content > section{
  height: 96vh;
  padding-bottom: 3em;
  overflow-y: auto;
}
.info{
  max-width:60em;
}
h1 {
  color:red;
  font-weight: 700;
  font-size: 2.5rem;
}
body {
  background-color: #e8efff;
  background-image: url("data:image/svg+xml,%3Csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 1600 900'%3E%3Cpolygon fill='%23cc0000' points='957 450 539 900 1396 900'/%3E%3Cpolygon fill='%23aa0000' points='957 450 872.9 900 1396 900'/%3E%3Cpolygon fill='%23d6002b' points='-60 900 398 662 816 900'/%3E%3Cpolygon fill='%23b10022' points='337 900 398 662 816 900'/%3E%3Cpolygon fill='%23d9004b' points='1203 546 1552 900 876 900'/%3E%3Cpolygon fill='%23b2003d' points='1203 546 1552 900 1162 900'/%3E%3Cpolygon fill='%23d3006c' points='641 695 886 900 367 900'/%3E%3Cpolygon fill='%23ac0057' points='587 900 641 695 886 900'/%3E%3Cpolygon fill='%23c4008c' points='1710 900 1401 632 1096 900'/%3E%3Cpolygon fill='%239e0071' points='1710 900 1401 632 1365 900'/%3E%3Cpolygon fill='%23aa00aa' points='1210 900 971 687 725 900'/%3E%3Cpolygon fill='%23880088' points='943 900 1210 900 971 687'/%3E%3C/svg%3E");
  background-attachment: fixed;
  background-size: cover;
  background-position: left bottom;
  /* background by SVGBackgrounds.com */
  font-family: Ubuntu;
  zoom: 0.8;
  background-repeat: no-repeat;
}
footer {
  position: fixed;
  bottom: 0px;
  width: 100%;
  text-align:right;
  background-color: rgba(255,255,255,0.2);
  padding: 5px;
  font-size: 120%;
  color: white;
  z-index: -1;
}
footer img{
  height: 30px;
  vertical-align: middle;
  margin-right: 5pt;
}
header, section{
  padding-left: 20px;
}
#mcx1-share label img{
  width: 20%;
}
input:required {
  background-color:#ffb700;
}
#mcxlibrary{
  width: 64%;
  max-height: 100%;
  float: left;
}
#simuinfo{
  width: 34%;
  float:right;
  background-color: rgba(48,55,66,0.4);
  color: white;
  display:none;
}
img.simupreview{
  width: 200px;
  margin: 2px;
  cursor: pointer;
}
#rpreview img{
  width: 100%;
}
#simuinfo dt{
  font-weight: bold;
  color: blue;
}
#simuinfo pre{
  background-color:green;
  margin: 5px;
}
#mcx1-browse input{
  height: 1.8rem;
}
#canvas{
  float:left;
}
#renderpanel{
  float:left;
  width: 20%;
  margin-left: 10px;
}
#renderpanel>* {
  width: 100%;
  margin-top:5px;
}
#credits {
  width: 100%;
  height: 100%;
  position: absolute;
  top: 0;
  left:0;
  background-color: rgba(48,55,66,0.95);;
  color: white;
  display:none;
  padding: 100px;
}
#opensourcelib{
  color: yellow;
  font-weight: bold;
  cursor: pointer;
}
#credits .closebtn{
  font-size: 50px;
  color: yellow;
  float: right;
}

</style>

<section id="mcx1-title" class='current'>
        <h1>MCX Cloud</h1>
	<h4>Scalable, cloud-based GPU Monte Carlo photon simulator based on <a href="http://mcx.space" title="Monte Carlo eXtreme">MCX</a> and <a href="https://neurojson.org" title="NeuroJSON">JData</a>. See <a href="https://youtu.be/TnfmrO12jI0" title="Video tutorial">Tutorial 1</a>,<a href="https://youtu.be/RztC-uXMqkw" title="Sharing and reuse simulations">2</a> & <a href="https://doi.org/10.1117/1.JBO.27.8.083008">Full Paper</a>.</h4>
	</p>
</section>


<header id="masthead" class="home">
        <nav id="site-navigation">
        	<div class="menu-navigation-container">
			<ul id="navbar" class="tab nav nav-tabs bigtab">
			<li class="tab-item"><a id="menu-browse" data-toggle="tab" href="#" onclick="showtab(event, 'browse')"><i class="fas fa-cloud-download-alt"></i>Browse</a></li>
			<li class="tab-item"><a id="menu-create" data-toggle="tab" href="#" onclick="showtab(event, 'create')"><i class="fas fa-edit"></i>Create</a></li>
			<li class="tab-item"><a id="menu-json"   data-toggle="tab" href="#" onclick="showtab(event, 'json')"><i class="fas fa-code"></i>JSON</a></li>
			<li class="tab-item"><a id="menu-preview" data-toggle="tab" href="#" onclick="showtab(event, 'preview')"><i class="fas fa-cube"></i>Preview</a></li>
			<li class="tab-item"><a id="menu-run"    data-toggle="tab" href="#" onclick="showtab(event, 'run')"><i class="fas fa-rocket"></i>Run</a></li>
			<li class="tab-item"><a id="menu-share"  data-toggle="tab" href="#" onclick="showtab(event, 'share')"><i class="fas fa-share-alt"></i>Share</a></li>
			<li class="tab-item"><a id="menu-schema" data-toggle="tab" href="#" onclick="showtab(event, 'schema')"><i class="far fa-file-code"></i>Schema</a></li>
			<li class="tab-item"><a id="direct-link" title="preserves JSON settings and options"><i class="fas fa-external-link-alt"></i>Link</a></li>
			<li class="tab-item"><a href="?" title="reload editor with default example settings"><i class="fas fa-undo"></i>Reset</a></li>
			<li class="tab-item"><a data-toggle="tab" href="#" onclick="showoptions()"><i class="fas fa-bars"></i>Options</a></li>
			</ul>
		</div>
        </nav><!-- #site-navigation -->
</header>

<section class='tab-content'>
    <section id="mcx1-browse" class='col-8 col-md-8 w-8/8'>
            <h2>Browse</h2>
            <input id="keyword" style="width:33%" name="fullname" type="text" value='' required minlength="3" placeholder="Search by keywords; if empty, retrieve the top downloaded (5 each time)">
            <button class='btn btn-primary' style="width:33%" id='btsearch' onclick="searchpub(0)">Search</button>
	    <button class='btn btn-primary' style="width:33%" id='btclearlib' onclick="clearpub()">Clear Results</button>
	    <div id="mcxlibrary"></div>
	    <div id="simuinfo">
	      <div id="rpreview"></div>
	      <p id="rtitle"></p>
	      <p id="rcomment"></p>
	      <p id="rlicense"></p>
	    </div>
    </section>

    <section id="mcx1-create" class='col-8 col-md-8 w-8/8'>
            <div id="json-editor-form"></div>
    </section>

    <section id="mcx1-json" class='col-8 col-md-8 w-8/8'>
            <h2>JSON Input</h2>
            <p>You can also make changes to the JSON here and set the value in the editor by clicking "Update Form"</p>
            <label for="output-textarea"></label>
            <button class='btn btn-primary btn-block' id='setvalue'>Update Form</button>
            <textarea id='output-textarea' rows="15" style="width: 100%; font-family: monospace;"
                      class='form-control'></textarea>
            <h2>Validation</h2>
            <label for="validate-textarea">This will update whenever the form changes to show validation errors if there
                are any.</label><br>
            <textarea id='validate-textarea' readonly disabled class='form-control'></textarea>
	    <a class='btn btn-primary btn-block' id='saveinput' href="#">Download Input</a>
    </section>

    <section id="mcx1-schema" class='col-8 col-md-8 w-8/8'>
            <h2>Schema</h2>
            <label for="schema-textarea">You can change the schema and see how the generated form looks. After you make
                changes, click "Update Schema"</label>
            <button class='btn btn-primary btn-block' id='setschema'>Update Schema</button>
            <textarea id='schema-textarea' rows="30" style="width: 100%; font-family: monospace;"
                      class='form-control'></textarea>
    </section>

    <section id="mcx1-preview" class='col-8 col-md-8 w-8/8' style="min-width: 1500px">
            <h2>Preview</h2>
	    <div id="canvas"></div>
	    <div id="renderpanel">
        <div style="display:block;">
          <b>Display Mode</b><br>
          <input type="radio" id="mip-radio-button" name="displaymode" value="mip" checked>
          <label for="mip">MIP</label><br>
          <input type="radio" id="iso-radio-button" name="displaymode" value="iso">
          <label for="iso">Isosurface</label>
        </div>
        <div style="display:block;">
          <b>Colormap</b><br>
          <label for="clim-low">Lower-bound</label><input id="clim-low" type="range" min="1" max="100" value="50" disabled><br>
          <label for="clim-hi">Upper-bound</label><input id="clim-hi" type="range" min="1" max="100" value="50" disabled>
        </div>
        <div style="display:block;">
          <b>Cross Sections</b><br>
          <div>
            X
            <label for="cross-x-low">Min </label><input style="width: 90px" id="cross-x-low" type="range" min="0" max="1" value="0" step="any">
            <label for="cross-x-hi">Max </label><input style="width: 90px" id="cross-x-hi" type="range" min="0" max="1" value="1" step="any">
          </div>
          <div>
            Y
            <label for="cross-y-low">Min </label><input style="width: 90px" id="cross-y-low" type="range" min="0" max="1" value="0" step="any">
            <label for="cross-y-hi">Max </label><input style="width: 90px" id="cross-y-hi" type="range" min="0" max="1" value="1" step="any">
          </div>
          <div>
            Z
            <label for="cross-z-low">Min </label><input style="width: 90px" id="cross-z-low" type="range" min="0" max="1" value="0" step="any">
            <label for="cross-z-hi">Max </label><input style="width: 90px" id="cross-z-hi" type="range" min="0" max="1" value="1" step="any">
          </div>
        </div>
        <div style="display:block;">
          <b>View</b><br>
          <button class='btn btn-primary' id="neg-x-view">-X</button>
          <button class='btn btn-primary' id="pos-x-view">+X</button>
          <button class='btn btn-primary' id="neg-y-view">-Y</button>
          <button class='btn btn-primary' id="pos-y-view">+Y</button>
          <button class='btn btn-primary' id="neg-z-view">-Z</button>
          <button class='btn btn-primary' id="pos-z-view">+Z</button>
        </div>
		    <div style="display:none">
		    Clip Plane <label for="camera-near">Near</label><input id="camera-near" type="range" min="1" max="100" value="50">
		    <label for="camera-far">Far</label><input id="camera-far" type="range" min="1" max="100" value="50">
		    </div>
		    <button class='btn btn-primary btn-block' id='drawlastinput'>Draw Last Input</button>
		    <button class='btn btn-primary btn-block' id='drawlastoutput'>Draw Last Output</button>
		    <button class='btn btn-primary btn-block' id='updatethumbnail'>Update Thumbnail</button>
		    <hr/>
		    <a class='btn btn-primary btn-block' id='saveoutput' href="#">Download Output</a>
		    <a class='btn btn-primary btn-block' id='savedetphoton' href="#">Download Detected Photon</a>
	    </div>
    </section>

    <section id="mcx1-run" class='col-8 col-md-8 w-8/8'>
            <h2>Run</h2>
	    <input id="fullname" name="fullname" type="text" value='' required minlength="3" placeholder="Full Name (required, internal use only, not be used publicly)">
	    <input id="netname" name="netname" type="text" value='' required minlength="3" placeholder="Network Name (required, for future public use)">
	    <input id="email" name="email" type="text" value='' required minlength="7" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" placeholder="Email (required, internal use only, not be used publicly)">
	    <input id="inst" name="inst" type="text" value='' required minlength="4" placeholder="Institute/Company (required, internal use only, not be used publicly)">
	    <input id="jobid" type="hidden" name="jobid" value=''>
	    <input id="jobhash" type="hidden" name="jobhash" value=''>

	    <button class='btn btn-primary btn-block' id='run'>Submit</button>

            <label for="run-log">Job status</label>
	    <textarea id='run-log' rows="30" style="width: 100%; font-family: monospace;" class='form-control'></textarea>
	    <button class='btn btn-primary btn-block' id='clearlog' onclick='$("#run-log").val("");'>Clear</button>
    </section>

    <section id="mcx1-share" class='col-8 col-md-8 w-8/8'>
            <h2>Share</h2>
	    <p>If you wish, you may use the below form to share your simulation by contributing it to our database. Submitted data can be reused by you and other users in the future (required shown in orange).</p>

	    <div id="shareinfo">
	    <input id="stitle" class="longinput" name="stitle" type="text" value='' required minlength="3" placeholder="Simulation Title (searchable, can not be empty)">
	    <textarea id='sdescription' rows="15" style="width: 100%; font-family: monospace;" class='form-control' placeholder="Description (searchable, can not be empty), may include citation information, background and detailed explanations"></textarea>
	    <input id="sfullname" class="shortinput" name="sfullname" type="text" value='' required minlength="3" placeholder="Your Name (required, public and searchable, may use 'Anonymous' if do not want to be acknowledged)">
	    <input id="semail" class="shortinput" name="semail" type="text" value='' required minlength="7" pattern="[a-z0-9._%+-]+@[a-z0-9.-]+\.[a-z]{2,}$" placeholder="Email (required, internal use only, not be used publicly)">
	    <input id="snetname" class="shortinput" name="snetname" type="text" value='' minlength="3" placeholder="Your Network Name (public and searchable)">
	    <input id="sinst" class="shortinput" name="sinst" type="text" value='' minlength="4" placeholder="Institute/Company (public, can be empty if you do not prefer to include)"><br/>
	    <label for="slicense">Permission</label><input type="radio" id="CC0" name="slicense" value="CC0"><label for="CC0"><img src="https://mirrors.creativecommons.org/presskit/buttons/88x31/png/cc-zero.png" title="CC0 (Can be reused for any purpose, you do not claim copyright to the submitted simulation setting/data)"/></label>
	    <input type="radio" id="CC-BY" name="slicense" value="CC-BY"><label for="CC-BY"><img src="https://mirrors.creativecommons.org/presskit/buttons/88x31/png/by.png" title="CC-BY (Can be reused for any purpose, but reuser must acknowledge the creator)"/></label>
	    <input type="radio" id="CC-BY-SA" name="slicense" value="CC-BY-SA"><label for="CC-BY-SA"><img src="https://mirrors.creativecommons.org/presskit/buttons/88x31/png/by-sa.png" title="CC-BY-SA (Can be reused for any purpose, but reuser must acknowledge the creator and adaption must be shared under the same terms)"/></label><br/>
	    </div>

	    <div id="previewinfo">
	    <label for="thumbnail">Preview</label><br/><img id="thumbnail" src="" title="Domain Preview"/>
	    </div>

	    <div id="submitshare">
	    <label for="sharesubmit">You must first successfully run your simulation before clicking this button</label><button class='btn btn-primary btn-block' id='sharesubmit' disabled>Submit</button>
	    </div>
    </section>

    <div id="mcx1-options" class="sidenav">
        <a href="javascript:void(0)" class="closebtn" onclick="hideoptions()" title="Close">&times;</a>
        <div>
            <h2>Options</h2>
            <div>
                <label for="boolean-options-select">Boolean options</label><br>
                <select multiple size="15" id="boolean-options-select" class="form-control browser-default">
                    <option value='required_by_default'>Object properties required by default</option>
                    <option value='display_required_only'>Only show required properties by default</option>
                    <option value='show_opt_in'>Show optional properties (with checkbox)</option>
                    <option value='no_additional_properties'>No additional object properties</option>
                    <option value='ajax'>Allow loading schemas via Ajax</option>
                    <option value='disable_edit_json'>Disable "Edit JSON" buttons</option>
                    <option value='disable_collapse'>Disable collapse buttons</option>
                    <option value='disable_properties'>Disable properties buttons</option>
                    <option value='disable_array_add'>Disable array add buttons</option>
                    <option value='disable_array_reorder'>Disable array move buttons</option>
                    <option value='disable_array_delete'>Disable array delete buttons</option>
                    <option value='enable_array_copy'>Add copy buttons to arrays</option>
                    <option value='array_controls_top'>Array controls will be displayed at top of list</option>
                    <option value='disable_array_delete_all_rows'>Disable array delete all rows buttons</option>
                    <option value='disable_array_delete_last_row'>Disable array delete last row buttons</option>
                </select>
            </div>
            <div>
                <label for="theme-select">theme</label><br>
                <select id='theme-select' name="theme" class='form-control browser-default'>
                    <option value='barebones'>Barebones</option>
                    <option value='bootstrap3'>Bootstrap 3</option>
                    <option value='bootstrap4'>Bootstrap 4</option>
                    <option value='html'>HTML</option>
                    <option value='spectre'>Spectre</option>
                    <option value='tailwind'>Tailwind</option>
                </select>
            </div>
            <div>
                <label for="iconlib-select">iconlib</label><br>
                <select id='iconlib-select' name="iconlib" class='form-control browser-default'>
                    <option value='fontawesome3'>fontawesome 3</option>
                    <option value='fontawesome4'>fontawesome 4</option>
                    <option value='fontawesome5'>fontawesome 5</option>
                    <option value='jqueryui'>jQuery UI</option>
                    <option value='spectre'>Spectre</option>
                </select>
            </div>
            <div>
                <label for="object-layout-select">Object Layout</label><br>
                <select id='object-layout-select' class='form-control browser-default'>
                    <option value='normal'>normal</option>
                    <option value='grid'>grid</option>
                </select>
            </div>
            <div>
                <label for="show-errors-select">Show Errors</label><br>
                <select id='show-errors-select' class='form-control browser-default'>
                    <option value='interaction'>On Interaction</option>
                    <option value='change'>On Field Change</option>
                    <option value='always'>Always</option>
                    <option value='never'>Never</option>
                </select>
            </div>
            <div>
                <label for="lib-select"
                       title="It's recommended that you click the Direct Link after changing these options">Include
                    External Library</label><br>
                <select multiple size="10" id='lib-select' class='form-control browser-default'
                        title="It's reccomended that you click the Direct Link after changing these options">
                    <option value='ace_editor'>Ace Editor</option>
                    <option value='choices'>Choices</option>
                    <option value='sceditor'>SCEditor</option>
                    <option value='simplemde'>SimpleMDE</option>
                    <option value='select2'>Select2</option>
                    <option value='selectize'>Selectize</option>
                    <option value='flatpickr'>Flatpickr</option>
                    <option value='signature_pad'>Signature Pad</option>
                    <option value='mathjs'>Math.js</option>
                    <option value='cleavejs'>Cleave.js</option>
                </select>
            </div>
        </div>
</section>

<section id="credits">
  <a href="javascript:void(0)" class="closebtn" onclick="$('#credits').hide();" title="Close">&times;</a>
  <h1>Acknowledgement</h1>
  <p>We acknowledge that MCX Cloud is built upon the following open-source libraries and resources</p>
 <div style="float:left;margin-right:3em;">
  <h3>Front-end</h3>
  <ul>
  <li>JSON Editor (<a href="https://github.com/json-editor/json-editor">https://github.com/json-editor/json-editor</a>)</li>
  <li>JSON Schema (<a href="https://json-schema.org/">https://json-schema.org/</a>)</li>
  <li>JData Specifications (<a href="https://neurojson.org/">https://neurojson.org/</a>)</li>
  <li>JQuery (<a href="https://jquery.com/">https://jquery.com/</a>)</li>
  <li>Three.js (<a href="https://threejs.org/">https://threejs.org/</a>)</li>
  <li>Ubuntu Font Family (<a href="https://design.ubuntu.com/font/">https://design.ubuntu.com/font/</a>)</li>
  <li>FontAwesome (<a href="https://fontawesome.com/">https://fontawesome.com/</a>)</li>
  <li>Pako (<a href="https://github.com/nodeca/pako">https://github.com/nodeca/pako</a>)</li>
  <li>Numjs (<a href="https://github.com/nicolaspanel/numjs">https://github.com/nicolaspanel/numjs</a>)</li>
  <li>lz-string (<a href="https://threejs.org/">https://threejs.org/</a>)</li>
  <li>JSData (<a href="https://github.com/fangq/jsdata">https://github.com/fangq/jsdata</a>)</li>
  <li>Spectre (<a href="https://picturepan2.github.io/spectre/">https://picturepan2.github.io/spectre/</a>)</li>
  <li>Bootstrap (<a href="https://getbootstrap.com/">https://getbootstrap.com/</a>)</li>
  <li>Background graphics: <a href="https://www.svgbackgrounds.com/#flat-mountains">SVG Backgrounds</a></li>
  </ul>
 </div>

 <div style="float:left">
  <h3>Backend</h3>
  <ul>
  <li>Monte Carlo eXtreme (MCX) (<a href="http://mcx.space/">http://mcx.space/</a>)</li>
  <li>Docker (<a href="https://docker.com/">https://docker.com/</a>)</li>
  <li>Docker Swarm (<a href="https://docs.docker.com/engine/swarm/">https://docs.docker.com/engine/swarm/</a>)</li>
  <li>Perl (<a href="https://www.perl.org/">https://perl.org</a>)</li>
  <li>DBI (<a href="https://dbi.perl.org/">https://dbi.perl.org/</a>)</li>
  <li>Sqlite (<a href="https://www.sqlite.org/">https://sqlite.org/</a>)</li>
  </ul>
 </div>
</section>

<footer>
  <span style="float:left">Copyright © 2021 <a href="http://github.com/fangq">Qianqian Fang</a></span>
  Brought to you by <a href="http://fanglab.org" title="COTI Lab/aka Fang Lab"><img src="https://neurojson.org/img/coti_favicon.png" title="COTI Lab@Northeastern"/>COTILab</a>
  <a href="http://mcx.space" title="MCX photon simulator"><img src="https://neurojson.org/img/mcx_logo_2020.png" title="MCX photon simulator"/>MCX</a>
  <a href="https://grantome.com/grant/NIH/R01-GM114365-06"><img src="https://neurojson.org/img/nih_nigms_logo.png" title="NIH/NIGMS Grant#R01-GM114365"/>NIH/NIGMS</a> 
  Powered by <span id="opensourcelib">open-source</span>
</footer>

<script>
  "use strict";

  var defaultSchema = 
{
  "title": "MCX JSON Input",
  "type": "object",
  "required": [
    "Session",
    "Forward",
    "Optode",
    "Shapes",
    "Domain"
  ],
  "format": "categories",
  "basicCategoryTitle": "Shapes",
  "properties": {
    "Session": {
      "type": "object",
      "title": "Session",
      "format": "grid",
      "required": [
        "ID",
        "Photons",
        "DoMismatch",
        "DoAutoThread"
      ],
      "properties": {
        "ID": {
          "title": "Session Name",
          "type": "string",
          "default": "mcx"
        },
        "Photons": {
          "title": "Photon number",
          "type": "integer",
          "default": 100000,
          "maximum": 1000000000
        },
        "DoMismatch": {
          "title": "Do reflection",
          "type": "boolean",
          "default": true
        },
        "DoAutoThread": {
          "title": "Let MCX decide thread/block size",
          "type": "boolean",
          "default": true
        },
        "DoSaveVolume": {
          "title": "Save fluence",
          "type": "boolean",
          "default": true
        },
	"DoPartialPath": {
          "title": "Save detected photons",
          "type": "boolean",
          "default": true
        },
	"DoNormalize": {
          "title": "Do normalization",
          "type": "boolean",
          "default": true
        },
	"DoSaveRef": {
          "title": "Save diffuse reflectance",
          "type": "boolean",
          "default": false
        },
	"DoSaveExit": {
          "title": "Save exit position",
          "type": "boolean",
          "default": false
        },
	"DoSaveSeed": {
          "title": "Save photon seeds",
          "type": "boolean",
          "default": false
        },
	"DoDCS": {
          "title": "Save momentum transfer",
          "type": "boolean",
          "default": false
        },
	"DoSpecular": {
          "title": "Do specular reflection",
          "type": "boolean",
          "default": true
        },
	"DebugFlag": {
	  "oneOf" :[
	   {
            "title": "Debug flags",
            "type": "string",
            "default": ""
	   },
	   {
            "title": "Debug flags",
            "type": "integer",
            "default": 0,
	    "minimum": 0
	   }
	  ]
        },
	"SaveDataMask": {
	  "oneOf" :[
	   {
            "title": "Save detected photon flags",
            "type": "string",
            "default": "DP"
	   },
	   {
            "title": "Save detected photon flags",
            "type": "integer",
            "default": 5,
	    "minimum": 0
	   }
	  ]
        },
	"OutputFormat": {
          "title": "Output file format",
          "type": "string",
	  "default": "nii",
          "enum": [
                "mc2",
                "nii",
		"jnii",
		"bnii",
                "hdr",
		"tx3"
              ]
        },
	"OutputType": {
          "title": "Output data type",
          "type": "string",
	  "default": "x",
          "enum": [
                "x",
                "f",
                "e",
                "j",
		"p",
		"m",
		"r"
              ]
        },
        "RNGSeed": {
          "title": "Random seed",
          "type": "number",
          "default": 1648335518
        }
      }
    },
    "Forward": {
      "type": "object",
      "title": "Forward",
      "format": "grid",
      "required": [
        "T0",
        "T1",
        "Dt"
      ],
      "properties": {
        "T0": {
          "title": "Starting time",
          "type": "number",
          "default": 0,
          "minimum": 0,
          "maximum": 1e-7
        },
        "T1": {
          "title": "Ending time",
          "type": "number",
          "default": 5e-9,
          "minimum": 0,
          "maximum": 1e-7
        },
        "Dt": {
          "title": "Time gate width",
          "type": "number",
          "default": 5e-9,
          "minimum": 0,
          "maximum": 1e-7
        }
      }
    },
    "Optode": {
      "type": "object",
      "title": "Optode",
      "required": [
        "Source"
      ],
      "properties": {
        "Source": {
          "title": "Source",
          "type": "object",
          "required": [
            "Type",
            "Pos",
            "Dir"
          ],
          "properties": {
            "Type": {
              "title": "Type",
              "type": "string",
              "default": "pencil",
              "enum": [
                "pencil",
                "isotropic",
                "cone",
                "gaussian",
                "planar",
                "pattern",
                "pattern3d",
                "fourier",
                "arcsine",
                "disk",
                "fourierx",
                "fourierx2d",
                "zgaussian",
                "line",
                "slit",
                "pencilarray"
              ]
            },
            "Pos": {
              "title": "Position",
              "type": "array",
              "format": "table",
              "items": {
                "type": "number"
              },
              "default": [
                30,
                30,
                0
              ],
              "minItems": 3,
              "maxItems": 3
            },
            "Dir": {
              "title": "Launch Direction",
              "type": "array",
              "format": "table",
              "default": [
                0,
                0,
                1
              ],
              "items": {
                "type": "number"
              },
              "minItems": 3,
              "maxItems": 4
            },
            "Param1": {
              "title": "Source Parameter 1",
              "type": "array",
              "format": "table",
	      "default": [
                0,
                0,
                0,
		0
              ],
              "items": {
                "type": "number"
              },
              "minItems": 4,
              "maxItems": 4
            },
            "Param2": {
              "title": "Source Parameter 2",
              "type": "array",
              "format": "table",
	      "default": [
                0,
                0,
                0,
		0
              ],
              "items": {
                "type": "number"
              },
              "minItems": 4,
              "maxItems": 4
            },
            "Frequency": {
              "title": "Modulation Frequency in Hz",
              "type": "number",
              "default": 0,
              "minimum": 0
            }
          }
        },
        "Detector": {
          "title": "Detector",
          "type": "array",
          "format": "table",
          "items": {
            "type": "object",
            "required": [
              "Pos",
              "R"
            ],
            "properties": {
              "Pos": {
                "title": "Position",
                "type": "array",
                "items": {
                  "type": "number"
                },
		"default": [
                  25,
                  30,
                  0
                ],
                "minItems": 3,
                "maxItems": 3
              },
              "R": {
                "title": "Radius",
                "type": "number",
                "default": 1,
                "minimum": 0
              }
            }
          }
        }
      }
    },
    "Shapes": {
      "title": "Shapes",
      "oneOf" :[
	{
	"type": "array",
	"format": "table",
	"items": {
          "anyOf": [
            {
              "title": "Grid",
              "type": "object",
              "required": ["Grid"],
              "properties": {
	          "Grid":{
                     "title": "Grid",
                     "type": "object",
		      "required": [
			"Tag",
			"Size"
		      ],
		     "properties": {
			  "Tag": {
			    "title": "Tag",
			    "type": "integer",
			    "default": 1,
			    "minimum": 0
			  },
			  "Size": {
			    "title": "Size",
			    "type": "array",
			    "format": "table",
			    "default": [
			       60,
			       60,
			       60
			    ],
			    "items": {
			      "type": "number"
			    },
			    "minItems": 3,
			    "maxItems": 3
			  }
		     }
		  }
        	}
            },
            {
              "title": "Sphere",
              "type": "object",
              "required": ["Sphere"],
              "properties": {
		"Sphere":{
                    "title": "Sphere",
                    "type": "object",
		    "required": [
		       "Tag",
		       "O",
		       "R"
		    ],
		    "properties": {
			  "Tag": {
			      "title": "Tag",
			      "type": "integer",
			      "minimum": 0
			    },
			    "O": {
			      "title": "Center",
			      "type": "array",
			      "format": "table",
			      "items": {
				"type": "number"
			      },
			      "default": [
				 30,
				 30,
				 30
			      ],
			      "minItems": 3,
			      "maxItems": 3
			    },
			    "R": {
			      "title": "Radius",
			      "type": "number",
			      "minimum": 0
			    }
		     }
		}
              }
            },
            {
              "title": "Box",
              "type": "object",
              "required": ["Box"],
              "properties": {
		"Box":{
                    "title": "Box",
                    "type": "object",
		    "required": [
		       "Tag",
		       "O",
		       "Size"
		    ],
		    "properties": {
			"Tag": {
			  "title": "Tag",
			  "type": "integer",
			  "minimum": 0
			},
			"Size": {
			  "title": "Size",
			  "type": "array",
			  "format": "table",
			  "items": {
			    "type": "integer",
			    "minimum": 0,
			    "default": 0
			  },
			  "minItems": 3,
			  "maxItems": 3
			},
			"O": {
			  "title": "Origin",
			  "type": "array",
			  "format": "table",
			  "items": {
			    "type": "integer",
			    "minimum": 0,
			    "default": 0
			  },
			  "minItems": 3,
			  "maxItems": 3
			}
		    }
		}
              }
            },
            {
              "title": "Subgrid",
              "type": "object",
              "required": ["Subgrid"],
              "properties": {
		"Subgrid":{
                    "title": "Subgrid",
                    "type": "object",
		    "required": [
		       "Tag",
		       "O",
		       "Size"
		    ],
  		    "properties": {
			"Tag": {
			  "title": "Tag",
			  "type": "integer",
			  "minimum": 0
			},
			"Size": {
			  "title": "Size",
			  "type": "array",
			  "format": "table",
			  "items": {
			    "type": "integer",
			    "minimum": 0,
			    "default": 0
			  },
			  "minItems": 3,
			  "maxItems": 3
			},
			"O": {
			  "title": "Origin",
			  "type": "array",
			  "format": "table",
			  "items": {
			    "type": "integer",
			    "minimum": 0,
			    "default": 0
			  },
			  "minItems": 3,
			  "maxItems": 3
			}
		    }
		}
              }
            },
            {
              "title": "Cylinder",
              "type": "object",
              "required": ["Cylinder"],
              "properties": {
		"Cylinder":{
                    "title": "Cylinder",
                    "type": "object",
		    "required": [
		       "Tag",
		       "C0",
		       "C1",
		       "R"
		    ],
  		    "properties": {
			"Tag": {
			  "title": "Tag",
			  "type": "integer",
			  "minimum": 0
			},
			"C0": {
			  "title": "Axis Center 1",
			  "type": "array",
			  "format": "table",
			  "items": {
			    "type": "number"
			  },
			  "minItems": 3,
			  "maxItems": 3
			},
			"C1": {
			  "title": "Axis Center 2",
			  "type": "array",
			  "format": "table",
			  "items": {
			    "type": "number"
			  },
			  "minItems": 3,
			  "maxItems": 3
			},
			"R": {
			  "title": "Radius",
			  "type": "number",
			  "minimum": 0
			}
		    }
		}
              }
            },
            {
              "title": "Name",
              "type": "object",
              "required": ["Name"],
              "properties": {
		 "Name":{
                     "type": "string",
	             "default": ""
		 }
	      }
            },
            {
              "title": "Origin",
              "type": "object",
              "required": ["Origin"],
              "properties": {
		"Origin":{
                    "title": "Origin",
                    "type": "array",
		    "format": "table",
		    "items": {
			    "type": "number",
			    "minimum": 0,
			    "default": 0
		    },
		    "minItems": 3,
		    "maxItems": 3
		}
              }
            },
            {
              "title": "XLayers",
              "type": "object",
              "required": ["XLayers"],
              "properties": {
		"XLayers":{
                    "title": "XLayers",
                    "type": "array",
		    "format": "table",
		    "items": {
			    "type": "array",
		            "format": "table",
			    "items": {
				    "type": "integer",
				    "minimum": 0,
				    "default": 0
			    },
			    "minItems": 3,
			    "maxItems": 3
		    }
		}
              }
            },
            {
              "title": "YLayers",
              "type": "object",
              "required": ["YLayers"],
              "properties": {
		"YLayers":{
                    "title": "YLayers",
                    "type": "array",
		    "format": "table",
		    "items": {
			    "type": "array",
		            "format": "table",
			    "items": {
				    "type": "integer",
				    "minimum": 0,
				    "default": 0
			    },
			    "minItems": 3,
			    "maxItems": 3
		    }
		}
              }
            },
            {
              "title": "ZLayers",
              "type": "object",
              "required": ["ZLayers"],
              "properties": {
		"ZLayers":{
                    "title": "ZLayers",
                    "type": "array",
		    "format": "table",
		    "items": {
			    "type": "array",
		            "format": "table",
			    "items": {
				    "type": "integer",
				    "minimum": 0,
				    "default": 0
			    },
			    "minItems": 3,
			    "maxItems": 3
		    }
		}
              }
            },
            {
              "title": "XSlabs",
              "type": "object",
              "required": ["XSlabs"],
              "properties": {
		"XSlabs":{
                    "title": "XSlabs",
                    "type": "object",
		    "required": [
		       "Tag",
		       "Bound"
		    ],
  		    "properties": {
			"Tag": {
			  "title": "Tag",
			  "type": "integer",
			  "minimum": 0
			},
			"Bound": {
			    "title": "Start/End Indices",
			    "type": "array",
			    "format": "table",
			    "items": {
				    "type": "array",
				    "format": "table",
				    "items": {
					    "type": "integer",
					    "minimum": 0,
					    "default": 0
				    },
				    "minItems": 2,
				    "maxItems": 2
			    }
			}
		    }
		}
	      }
            },
            {
              "title": "YSlabs",
              "type": "object",
              "required": ["YSlabs"],
              "properties": {
		"YSlabs":{
                    "title": "YSlabs",
                    "type": "object",
		    "required": [
		       "Tag",
		       "Bound"
		    ],
  		    "properties": {
			"Tag": {
			  "title": "Tag",
			  "type": "integer",
			  "minimum": 0
			},
			"Bound": {
			    "title": "Start/End Indices",
			    "type": "array",
			    "format": "table",
			    "items": {
				    "type": "array",
				    "format": "table",
				    "items": {
					    "type": "integer",
					    "minimum": 0,
					    "default": 0
				    },
				    "minItems": 2,
				    "maxItems": 2
			    }
			}
		    }
		}
	      }
            },
            {
              "title": "ZSlabs",
              "type": "object",
              "required": ["ZSlabs"],
              "properties": {
		"ZSlabs":{
                    "title": "ZSlabs",
                    "type": "object",
		    "required": [
		       "Tag",
		       "Bound"
		    ],
  		    "properties": {
			"Tag": {
			  "title": "Tag",
			  "type": "integer",
			  "minimum": 0
			},
			"Bound": {
			    "title": "Start/End Indices",
			    "type": "array",
			    "format": "table",
			    "items": {
				    "type": "array",
				    "format": "table",
				    "items": {
					    "type": "integer",
					    "minimum": 0,
					    "default": 0
				    },
				    "minItems": 2,
				    "maxItems": 2
			    }
			}
		    }
		}
	      }
            }
          ]
	}
      },
      {
            "type": "object",
            "required": ["_ArrayType_","_ArraySize_","_ArrayZipType_","_ArrayZipSize_","_ArrayZipData_"],
            "properties": {
	      "_ArrayType_":{
		  "type": "string",
		  "default": "uint8",
		  "enum": [
			"uint8",
			"uint16",
			"uint32",
			"int8",
			"int16",
			"int32",
			"single"
		      ]
	      },
	      "_ArraySize_":{
		  "type": "array",
		  "default": [0,0,0],
		  "format": "table",
		  "items": {
		      "type": "integer",
		      "minimum": 0
		  },
	          "minItems": 3,
	          "maxItems": 3
	      },
	      "_ArrayZipType_":{
		  "type": "string",
		  "default": "zlib",
		  "enum": [
			"zlib",
			"gzip"
		      ]
	      },
	      "_ArrayZipSize_":{
	          "oneOf" :[
		      {
			  "type": "integer",
			  "default": 0,
			  "minimum": 0
		      },
		      {
			  "type": "array",
			  "default": [0,0],
			  "format": "table",
			  "items": {
			      "type": "integer",
			      "minimum": 0
			  },
			  "minItems": 2,
			  "maxItems": 2
		      }
		  ]
	      },
	      "_ArrayZipData_":{
		  "type": "string",
		  "default": ""
	      }
	    }
	}
      ]
    },
    "Domain": {
      "type": "object",
      "title": "Domain",
      "required": [
        "Media",
        "Dim",
        "OriginType"
      ],
      "properties": {
        "OriginType": {
          "title": "Origin at [0,0,0]",
          "type": "boolean",
          "default": true
        },
        "Dim": {
          "title": "Dimensions",
          "type": "array",
          "format": "table",
          "items": {
            "type": "integer"
          },
          "default": [
            60,
            60,
            60
          ],
          "minItems": 3,
          "maxItems": 3
        },
	"LengthUnit": {
          "title": "Voxel Size (in mm)",
          "type": "number",
          "default": 1,
          "minimum": 0
	},
	"MediaFormat": {
          "title": "Binary Volume Format",
          "type": "string",
	  "default": "byte",
          "enum": [
                "byte",
                "short",
		"svmc",
		"mixlabel",
                "labelplus",
		"muamus_float",
		"muamus_half",
		"asgn_byte",
		"muamus_short"
              ]
        },
        "VolumeFile": {
          "title": "Volume File",
          "type": "string",
          "default": ""
        },
        "Media": {
          "title": "Media",
          "type": "array",
          "format": "table",
          "minItems": 2,
          "items": {
            "type": "object",
            "required": [
              "mua",
              "mus",
              "g",
              "n"
            ],
            "properties": {
              "mua": {
                "title": "Absorption (μa 1/mm)",
                "type": "number",
                "default": 0,
                "minimum": 0
              },
              "mus": {
                "title": "Scattering (μs 1/mm)",
                "type": "number",
                "default": 0,
                "minimum": 0
              },
              "g": {
                "title": "Anisotropy (g)",
                "type": "number",
                "default": 1,
                "minimum": -1,
                "maximum": 1
              },
              "n": {
                "title": "Refractive Index (n)",
                "type": "number",
                "default": 1,
                "minimum": 0
              }
            }
          }
        }
      }
    }
  }
}

function createFragmentShader(mode) {
  return [
		'		precision highp float;',
		'		precision mediump sampler3D;',

		'		uniform vec3 u_size;',
		'		uniform int u_renderstyle;',
		'		uniform float u_renderthreshold;',
		'		uniform vec2 u_clim;',

		'		uniform sampler3D u_data;',
		'		uniform sampler2D u_cmdata;',
    '		uniform vec3 u_minslice;',
    '		uniform vec3 u_maxslice;',

		'		varying vec3 v_position;',
		'		varying vec4 v_nearpos;',
		'		varying vec4 v_farpos;',

		// The maximum distance through our rendering volume is sqrt(3).
		'		const int MAX_STEPS = 887;	// 887 for 512^3, 1774 for 1024^3',
		'		const int REFINEMENT_STEPS = 4;',
		'		const float relative_step_size = 1.0;',
		'		const vec4 ambient_color = vec4(0.2, 0.4, 0.2, 1.0);',
		'		const vec4 diffuse_color = vec4(0.8, 0.2, 0.2, 1.0);',
		'		const vec4 specular_color = vec4(1.0, 1.0, 1.0, 1.0);',
		'		const float shininess = 40.0;',

		'		void cast_mip(vec3 start_loc, vec3 step, int nsteps, vec3 view_ray);',
		'		void cast_iso(vec3 start_loc, vec3 step, int nsteps, vec3 view_ray);',

		'		float sample1(vec3 texcoords);',
		'		vec4 apply_colormap(float val);',
		'		vec4 add_lighting(float val, vec3 loc, vec3 step, vec3 view_ray);',


		'		void main() {',
		// Normalize clipping plane info
		'				vec3 farpos = v_farpos.xyz / v_farpos.w;',
		'				vec3 nearpos = v_nearpos.xyz / v_nearpos.w;',

		// Calculate unit vector pointing in the view direction through this fragment.
		'				vec3 view_ray = normalize(nearpos.xyz - farpos.xyz);',
		// Compute the (negative) distance to the front surface or near clipping plane.
		// v_position is the back face of the cuboid, so the initial distance calculated in the dot
		// product below is the distance from near clip plane to the back of the cuboid

    '				float distance = dot(nearpos - v_position, view_ray);',
    '				vec3 cmp = (-vec3(0.5) - v_position) / view_ray;',
    '				vec3 cmpu = (u_size * vec3(1.0, 1.0, 1.0)) / view_ray + cmp;',
    '				cmp = min(cmp, cmpu);',
		'				distance = max(distance, max(cmp.x, max(cmp.y, cmp.z)));',

		// Now we have the starting position on the front surface
		'				vec3 front = v_position + view_ray * distance;',

		// Decide how many steps to take
		'				int nsteps = max(1, int(-distance / relative_step_size + 0.5));',

		// Get starting location and step vector in texture coordinates
		'				vec3 step = ((v_position - front) / u_size) / float(nsteps);',
		'				vec3 start_loc = front / u_size;',

    // Clip starting position and step count within the bounding box defined by u_minslice and u_maxslice
    // allowing for cross-sectional views.
    `       vec3 nstepminbound = mix(vec3(float(0)), (u_maxslice - start_loc) / step, greaterThan(start_loc, u_maxslice));
            float skips = max(nstepminbound.x, max(nstepminbound.y, nstepminbound.z));
            nstepminbound = mix(vec3(float(0)), (u_minslice - start_loc) / step, lessThan(start_loc, u_minslice));
            skips = max(skips, max(nstepminbound.x, max(nstepminbound.y, nstepminbound.z)));
            start_loc += skips * step;
            nsteps -= int(skips + 0.5);`,
    
    `       vec3 nstepmaxbound = mix(vec3(float(nsteps)), ceil((u_maxslice - start_loc) / step), greaterThan((start_loc + float(nsteps) * step), u_maxslice));
            nstepmaxbound = min(nstepmaxbound, mix(vec3(float(nsteps)), ceil((u_minslice - start_loc) / step), lessThan((start_loc + float(nsteps) * step), u_minslice)));
            nsteps = int(min(nstepmaxbound.x, min(nstepmaxbound.y, nstepmaxbound.z)) + 0.5);`,

		// For testing: show the number of steps. This helps to establish
		// whether the rays are correctly oriented
		//'gl_FragColor = vec4(0.0, float(nsteps) / 1.0 / u_size.x, 1.0, 1.0);',
		//'return;',
    `
            if(` + mode + `) {
                cast_mip(start_loc, step, nsteps, view_ray);
            }
            else {
                cast_iso(start_loc, step, nsteps, view_ray);
            }
    `,
		'		}',


		'		float sample1(vec3 texcoords) {',
		'				/* Sample float value from a 3D texture. Assumes intensity data. */',
		'				return texture(u_data, texcoords.xyz).r;',
		'		}',


		'		vec4 apply_colormap(float val) {',
		'				val = (val - u_clim.x) / (u_clim.y - u_clim.x);',
		'				return texture2D(u_cmdata, vec2(val, 0.5));',
		'		}',


		'		void cast_mip(vec3 start_loc, vec3 step, int nsteps, vec3 view_ray) {',

		'				float max_val = 0.0;',
		'				vec3 loc = start_loc;',

		// Enter the raycasting loop. In WebGL 1 the loop index cannot be compared with
		// non-constant expression. So we use a hard-coded max, and an additional condition
		// inside the loop.
    isWebGL2Available() ? 'for (int iter=0; iter<=nsteps; iter++) {' : 'for (int iter=0; iter<=MAX_STEPS; iter++) {\nif(iter >= nsteps) break;',
		// Sample from the 3D texture
		'						float val = sample1(loc);',
		// Apply MIP operation
    '						max_val = max(val, max_val);',
		// Advance location deeper into the volume
		'						loc += step;',
		'				}',

		// Resolve final color
		'				gl_FragColor = apply_colormap(max_val);',
		'		}',

		'		void cast_iso(vec3 start_loc, vec3 step, int nsteps, vec3 view_ray) {',

		'				vec4 color3 = vec4(0.0);	// final color',
		'				vec3 dstep = 1.5 / u_size;	// step to sample derivative',
		'				vec3 loc = start_loc;',

		'				float low_threshold = u_renderthreshold - 0.02 * (u_clim.y - u_clim.x);',
		'				float val = 0.0;',

		// Enter the raycasting loop. In WebGL 1 the loop index cannot be compared with
		// non-constant expression. So we use a hard-coded max, and an additional condition
		// inside the loop.
    isWebGL2Available() ? 'for (int iter=0; iter<=nsteps; iter++) {' : 'for (int iter=0; iter<=MAX_STEPS; iter++) {\nif(iter >= nsteps) break;',
		// Sample from the 3D texture
		'						val = sample1(loc);',

		'						if (val > u_renderthreshold) {',
		// Take the last interval in smaller steps
		'								break;',
		'						}',

		// Advance location deeper into the volume
		'						loc += step;',
		'				}',
    
    '				if (val > u_renderthreshold) {',
		// Take the last interval in smaller steps
		'						vec3 iloc = loc - 0.5 * step;',
		'						vec3 istep = step / float(REFINEMENT_STEPS);',
		'						for (int i=0; i<REFINEMENT_STEPS; i++) {',
		'								val = sample1(iloc);',
		'								if (val > u_renderthreshold) {',
		'										gl_FragColor = add_lighting(val, iloc, dstep, view_ray);',
		'										return;',
		'								}',
		'								iloc += istep;',
		'						}',
    '						gl_FragColor = add_lighting(val, iloc, dstep, view_ray);',
		'				}',
    '       else {',
		'			    	gl_FragColor = vec4(0.0);',
    '       }',
		'		}',

		'		vec4 add_lighting(float val, vec3 loc, vec3 step, vec3 view_ray)',
		'		{',
		// Calculate color by incorporating lighting

		// View direction
		'				vec3 V = normalize(view_ray);',

		// calculate normal vector from gradient
		'				vec3 N;',
		'				float val1, val2;',
		'				val1 = sample1(loc + vec3(-step[0], 0.0, 0.0));',
		'				val2 = sample1(loc + vec3(+step[0], 0.0, 0.0));',
		'				N[0] = val1 - val2;',
		'				val = max(max(val1, val2), val);',
		'				val1 = sample1(loc + vec3(0.0, -step[1], 0.0));',
		'				val2 = sample1(loc + vec3(0.0, +step[1], 0.0));',
		'				N[1] = val1 - val2;',
		'				val = max(max(val1, val2), val);',
		'				val1 = sample1(loc + vec3(0.0, 0.0, -step[2]));',
		'				val2 = sample1(loc + vec3(0.0, 0.0, +step[2]));',
		'				N[2] = val1 - val2;',
		'				val = max(max(val1, val2), val);',

		'				float gm = length(N); // gradient magnitude',
		'				N = normalize(N);',

		// Flip normal so it points towards viewer
		'				float Nselect = float(dot(N, V) > 0.0);',
		'				N = (2.0 * Nselect - 1.0) * N;	// ==	Nselect * N - (1.0-Nselect)*N;',

		// Init colors
		'				vec4 ambient_color = vec4(0.0, 0.0, 0.0, 0.0);',
		'				vec4 diffuse_color = vec4(0.0, 0.0, 0.0, 0.0);',
		'				vec4 specular_color = vec4(0.0, 0.0, 0.0, 0.0);',

		// note: could allow multiple lights
		'				for (int i=0; i<1; i++)',
		'				{',
								 // Get light direction (make sure to prevent zero devision)
		'						vec3 L = normalize(view_ray);	//lightDirs[i];',
		'						float lightEnabled = float( length(L) > 0.0 );',
		'						L = normalize(L + (1.0 - lightEnabled));',

		// Calculate lighting properties
		'						float lambertTerm = clamp(dot(N, L), 0.0, 1.0);',
		'						vec3 H = normalize(L+V); // Halfway vector',
		'						float specularTerm = pow(max(dot(H, N), 0.0), shininess);',

		// Calculate mask
		'						float mask1 = lightEnabled;',

		// Calculate colors
		'						ambient_color +=	mask1 * ambient_color;	// * gl_LightSource[i].ambient;',
		'						diffuse_color +=	mask1 * lambertTerm;',
		'						specular_color += mask1 * specularTerm * specular_color;',
		'				}',

		// Calculate final color by componing different components
		'				vec4 final_color;',
		'				vec4 color = apply_colormap(val);',
		'				final_color = color * (ambient_color + diffuse_color) + specular_color;',
		'				final_color.a = color.a;',
		'				return final_color;',
		'		}',
	].join( '\n' );
}

var MipRenderShader = {
	uniforms: {
		'u_size': { value: new THREE.Vector3( 1, 1, 1 ) },
		'u_renderstyle': { value: 0 },
		'u_renderthreshold': { value: 0.5 },
		'u_clim': { value: new THREE.Vector2( 1, 1 ) },
		'u_data': { value: null },
		'u_cmdata': { value: null },
    'u_minslice': { value: new THREE.Vector3( 0, 0, 0 ) },
    'u_maxslice': { value: new THREE.Vector3( 1, 1, 1 ) }
	},
	vertexShader: [
		'		varying vec4 v_nearpos;',
		'		varying vec4 v_farpos;',
		'		varying vec3 v_position;',

		'		void main() {',
		// Prepare transforms to map to "camera view". See also:
		// https://threejs.org/docs/#api/renderers/webgl/WebGLProgram
		'				mat4 viewtransformf = modelViewMatrix;',
		'				mat4 viewtransformi = inverse(modelViewMatrix);',

		// Project local vertex coordinate to camera position. Then do a step
		// backward (in cam coords) to the near clipping plane, and project back. Do
		// the same for the far clipping plane. This gives us all the information we
		// need to calculate the ray and truncate it to the viewing cone.
		'				vec4 position4 = vec4(position, 1.0);',
		'				vec4 pos_in_cam = viewtransformf * position4;',

		// Intersection of ray and near clipping plane (z = -1 in clip coords)
		'				pos_in_cam.z = -pos_in_cam.w;',
		'				v_nearpos = viewtransformi * pos_in_cam;',

		// Intersection of ray and far clipping plane (z = +1 in clip coords)
		'				pos_in_cam.z = pos_in_cam.w;',
		'				v_farpos = viewtransformi * pos_in_cam;',

		// Set varyings and output pos
		'				v_position = position;',
		'				gl_Position = projectionMatrix * viewMatrix * modelMatrix * position4;',
		'		}',
	].join( '\n' ),
	fragmentShader: createFragmentShader(true)
};

var IsoRenderShader = {
	uniforms: MipRenderShader.uniforms,
	vertexShader: MipRenderShader.vertexShader,
	fragmentShader: createFragmentShader(false)
};

  // parse url -> merge options -> refreshUI() -> initJsoneditor() -> direct link

  /* ------------------------------------------------------------------- data */

  var data = {}

  var defaultOptions = {
    iconlib: 'fontawesome5',
    object_layout: 'normal',
    schema: defaultSchema,
    show_errors: 'interaction',
    theme: 'spectre',
    no_additional_properties: true
  }

  var jsoneditor = null
  var directLink = document.querySelector('#direct-link')

  var booleanOptionsSelect = document.querySelector('#boolean-options-select')
  var head = document.getElementsByTagName('head')[0]
  var iconlibSelect = document.querySelector('#iconlib-select')
  var iconlibLink = document.querySelector('#iconlib-link')
  var libSelect = document.querySelector('#lib-select')
  var jsonEditorForm = document.querySelector('#json-editor-form')
  var objectLayoutSelect = document.querySelector('#object-layout-select')
  var outputTextarea = document.querySelector('#output-textarea')
  var schemaTextarea = document.querySelector('#schema-textarea')
  var setSchema = document.querySelector('#setschema')
  var setValue = document.querySelector('#setvalue')
  var showErrorsSelect = document.querySelector('#show-errors-select')
  var themeSelect = document.querySelector('#theme-select')
  var themeLink = document.querySelector('#theme-link')
  var validateTextarea = document.querySelector('#validate-textarea')

  /* -------------------------------------------------------------- parse url */

  var parseUrl = function () {
    var url = window.location.search
    var queryParamsString = url.substring(1, url.length)
    var queryParams = queryParamsString.split('&')
    let inittab=''

    if (queryParamsString.length) {
      queryParams.forEach(function (queryParam) {
        var splittedParam = queryParam.split('=')
        var param = splittedParam[0]
        var value = splittedParam[1]

        // data query param
        if (param === 'data') {
          // compress schema and value
          try {
            data = JSON.parse(LZString.decompressFromBase64(value))
          } catch (reason) {
          }
        }else if (param === 'tab') {
          inittab=value;
	}
      })
    }

    mergeOptions()

    if(inittab!==''){
	  lastjson='';
	  showtab({'target': document.querySelector('#menu-'+inittab)}, inittab)
    }
  }

  /* ----------------------------------------------------------- mergeOptions */

  var mergeOptions = function () {
    data.options = Object.assign(defaultOptions, data.options)
    refreshUI()
  }

  /* -------------------------------------------------------------- refreshUI */

  var refreshUI = function () {
    // schema
    if(data.options.hasOwnProperty('schema'))
       schemaTextarea.value = JSON.stringify(data.options.schema, null, 2)
    else
       schemaTextarea.value = defaultSchema;

    // theme
    var themeMap = {
      barebones: '',
      bootstrap3: 'https://stackpath.bootstrapcdn.com/bootstrap/3.4.1/css/bootstrap.min.css',
      bootstrap4: 'https://maxcdn.bootstrapcdn.com/bootstrap/4.0.0/css/bootstrap.min.css',
      html: '',
      spectre: 'https://unpkg.com/spectre.css/dist/spectre.min.css',
      tailwind: 'https://unpkg.com/tailwindcss@^1.0/dist/tailwind.min.css'
    }
    themeLink.href = themeMap[data.options.theme]
    themeSelect.value = data.options.theme

    // iconlLib
    var iconLibMap = {
      fontawesome3: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/3.2.1/css/font-awesome.css',
      fontawesome4: 'https://cdnjs.cloudflare.com/ajax/libs/font-awesome/4.0.3/css/font-awesome.css',
      fontawesome5: 'https://use.fontawesome.com/releases/v5.6.1/css/all.css',
      jqueryui: 'https://code.jquery.com/ui/1.10.3/themes/south-street/jquery-ui.css',
      spectre: 'https://unpkg.com/spectre.css/dist/spectre-icons.min.css'
    }
    iconlibLink.href = iconLibMap[data.options.iconlib]
    iconlibSelect.value = data.options.iconlib

    // object_layout
    objectLayoutSelect.value = data.options.object_layout

    // show_errors
    showErrorsSelect.value = data.options.show_errors

    // boolean values
    var booleanOptions = booleanOptionsSelect.children
    for (var i = 0; i < booleanOptions.length; i++) {
      var booleanValue = booleanOptions[i]
      if (data.options[booleanValue.value]) {
        booleanValue.selected = true
      }
    }

    // libs
    var libMapping = {
      ace_editor: {
        js: [
          'https://cdn.jsdelivr.net/npm/ace-editor-builds@1.2.4/src-min-noconflict/ace.js'
        ],
        css: []
      },
      choices: {
        js: [
          'https://cdn.jsdelivr.net/npm/choices.js/public/assets/scripts/choices.min.js'
        ],
        css: [
          'https://cdn.jsdelivr.net/npm/choices.js/public/assets/styles/choices.min.css'
        ]
      },
      cleavejs: {
        js: [
          'https://cdn.jsdelivr.net/npm/cleave.js@1.4.7/dist/cleave.min.js'
        ],
        css: []
      },
      sceditor: {
        js: [
          'https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js',
          'https://cdn.jsdelivr.net/npm/sceditor@2.1.3/minified/sceditor.min.js',
          'https://cdn.jsdelivr.net/npm/sceditor@2.1.3/minified/formats/bbcode.js',
          'https://cdn.jsdelivr.net/npm/sceditor@2.1.3/minified/formats/xhtml.js'
        ],
        css: [
          'https://cdn.jsdelivr.net/npm/sceditor@2.1.3/minified/themes/default.min.css'
        ]
      },
      simplemde: {
        js: [
          'https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.js'
        ],
        css: [
          'https://cdn.jsdelivr.net/simplemde/latest/simplemde.min.css'
        ]
      },
      select2: {
        js: [
          'https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js',
          'https://cdn.jsdelivr.net/npm/select2@4.0.6-rc.1/dist/js/select2.min.js'
        ],
        css: [
          'https://cdn.jsdelivr.net/npm/select2@4.0.6-rc.1/dist/css/select2.min.css'
        ]
      },
      selectize: {
        js: [
          'https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/js/standalone/selectize.min.js'
        ],
        css: [
          'https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.min.css',
          'https://cdn.jsdelivr.net/npm/selectize@0.12.6/dist/css/selectize.default.min.css'
        ]
      },
      flatpickr: {
        js: [
          'https://cdn.jsdelivr.net/npm/flatpickr'
        ],
        css: [
          'https://cdn.jsdelivr.net/npm/flatpickr/dist/flatpickr.min.css'
        ]
      },
      signature_pad: {
        js: [
          'https://cdn.jsdelivr.net/npm/signature_pad@2.3.2/dist/signature_pad.min.js'
        ],
        css: []
      },
      mathjs: {
        js: [
          'https://cdn.jsdelivr.net/npm/mathjs@5.3.1/dist/math.min.js'
        ],
        css: []
      },
    }

    if (data.selectedLibs || data.unselectedLibs) {

      var booleanOptions = booleanOptionsSelect.children
      for (var i = 0; i < booleanOptions.length; i++) {
        var booleanValue = booleanOptions[i]
        if (data.options[booleanValue.value]) {
          booleanValue.selected = true
        }
      }

      var libSelectChildren = libSelect.children
      for (var i = 0; i < libSelectChildren.length; i++) {
        var child = libSelectChildren[i]
        child.selected = data.selectedLibs.includes(child.value)
      }

      // remove libraries
      data.unselectedLibs.forEach(function (selectedLib) {
        var concat = libMapping[selectedLib].js.concat(libMapping[selectedLib].css)
        concat.forEach(function () {
          var className = '.external_' + selectedLib
          var toRemove = head.querySelector(className)
          if (toRemove) {
            toRemove.parentNode.removeChild(toRemove)
          }
        })
      })

      // add libraries
      data.selectedLibs.forEach(function (selectedLib) {
        // add js
        libMapping[selectedLib].js.forEach(function (js) {
          var scriptElement = document.createElement('script')
          scriptElement.type = 'text/javascript'
          scriptElement.src = js
          scriptElement.async = false
          scriptElement.classList.add('external_' + selectedLib)
          head.appendChild(scriptElement)
        })
        // add css
        libMapping[selectedLib].css.forEach(function (css) {
          var linkElement = document.createElement('link')
          linkElement.setAttribute('rel', 'stylesheet')
          linkElement.setAttribute('type', 'text/css')
          linkElement.setAttribute('href', css)
          linkElement.classList.add('external_' + selectedLib)
          head.appendChild(linkElement)
        })
      })
    }

    initJsoneditor()

    if(data.options.hasOwnProperty('json')){
       outputTextarea.value = JSON.stringify(data.options.json, null, 2)
       if (jsoneditor) {
         jsoneditor.on('ready',() => {
           $("#setvalue").click();
         });
       }
    }
  }

  /* --------------------------------------------------------- initJsoneditor */

  var initJsoneditor = function () {
    // destroy old JSONEditor instance if exists
    if (jsoneditor) {
      jsoneditor.destroy()
    }

    // new instance of JSONEditor
    jsoneditor = new window.JSONEditor(jsonEditorForm, data.options)

    // listen for changes
    jsoneditor.on('change', function () {
      // output
      var json = jsoneditor.getValue()
      outputTextarea.value = JSON.stringify(json, null, 2)

      // validate
      var validationErrors = jsoneditor.validate()
      if (validationErrors.length) {
        validateTextarea.value = JSON.stringify(validationErrors, null, 2)
      } else {
        validateTextarea.value = 'valid'
      }
    })
    updateDirectLink()
  }

  /* ------------------------------------------------------- updateDirectLink */

  var updateDirectLink = function () {
    var url = window.location.href.replace(/\?.*/, '').replace(/#$/,'')
    url += '?tab=preview&data='
    let linkdata={options: Object.assign({},data.options)};
    delete linkdata.options.schema;
    url += LZString.compressToBase64(JSON.stringify(linkdata))
    directLink.href = url
  }

  /* -------------------------------------------------------- event listeners */

  setValue.addEventListener('click', function () {
    data.options.json = JSON.parse(outputTextarea.value.replace(/\n/g,''));
    jsoneditor.setValue(data.options.json)
    updateDirectLink();
    updatejsonlink("saveinput", outputTextarea.value, "input.json");
  })

  setSchema.addEventListener('click', function () {
    try {
      data.options.schema = JSON.parse(schemaTextarea.value)
    } catch (e) {
      alert('Invalid Schema: ' + e.message)
      return
    }
    refreshUI()
  })

  themeSelect.addEventListener('change', function () {
    data.options.theme = this.value || ''
    refreshUI()
  })

  iconlibSelect.addEventListener('change', function () {
    data.options.iconlib = this.value || ''
    refreshUI()
  })

  objectLayoutSelect.addEventListener('change', function () {
    data.options.object_layout = this.value || ''
    refreshUI()
  })

  showErrorsSelect.addEventListener('change', function () {
    data.options.show_errors = this.value || ''
    refreshUI()
  })

  booleanOptionsSelect.addEventListener('change', function () {
    var booleanOptions = this.children
    for (var i = 0; i < booleanOptions.length; i++) {
      data.options[booleanOptions[i].value] = booleanOptions[i].selected
    }
    refreshUI()
  })

  libSelect.addEventListener('change', function () {
    data.selectedLibs = []
    data.unselectedLibs = []

    var libs = this.children

    for (var i = 0; i < libs.length; i++) {
      if (libs[i].selected) {
        data.selectedLibs.push(libs[i].value)
      } else {
        data.unselectedLibs.push(libs[i].value)
      }
    }
    refreshUI()
  })

  /* -------------------------------------------------------- mcxone functions */

var timer, jobid, count=0, lastjson="";

function showoptions() {
  $("#mcx1-options").css("width","400px");
}

function hideoptions() {
  $("#mcx1-options").css("width","0");
}

function sleep (time) {
  return new Promise((resolve) => setTimeout(resolve, time));
}

function updatethumb(lastdatastr='', waittime=0){
  renderer.setSize( canvas.width()/2, canvas.height()/2 );
  if(lastdatastr !== ''){
    let cfg = JSON.parse(lastdatastr);
    drawpreview(cfg);
  }
  if(waittime>0){
    renderer.updateComplete = false;
    sleep(waittime).then(() => {
      let screenshot = renderer.domElement.toDataURL("image/png");
      $("#thumbnail").attr('src', screenshot);
      console.log(screenshot.length);
      renderer.setSize( canvas.width(), canvas.height() );
      renderer.render( scene, camera );
    });
  }else{
    renderer.setSize( canvas.width(), canvas.height() );
    renderer.render( scene, camera );
  }
}

function showtab(event, name) {
  $("#navbar").removeClass('bigtab');
  $('#navbar a').removeClass('active');
  $(".col-md-8").removeClass('active');
  $("#mcx1-"+name).addClass('active');
  $("#site-navigation li").removeClass('active');
  event.target.parentNode.classList.add('active');
  if(name === "preview" || name === "share"){
      if(reqid !== undefined) {
        cancelAnimationFrame(reqid);
      }
      reqid=requestAnimationFrame(update);
      if(lastjson != $("#output-textarea").val()){
          lastjson=$("#output-textarea").val();
          updatethumb(lastjson, ($("#thumbnail").attr('src').length==0 ? 300 : 0));
      }
  }else if(reqid!==undefined){
      cancelAnimationFrame(reqid);
  }
}

function updatedetplink(data){
  $("#savedetphoton").unbind('click');
  updatejsonlink("savedetphoton", JSON.stringify(data), "output_detp.json");
  $("#savedetphoton").text("Click to Save Detected Photon Data");
}

function getdetphoton() {
  $.ajax({
      url: serverurl,
      data: { 'jobid': jobid, 'hash': $("#jobhash").val(), 'action': 'detphoton' },
      type: 'GET',
      crossOrigin: true,
      dataType: 'jsonp',
      jsonp: 'callback',
      jsonpCallback: 'updatedetplink',
      success: function( data ){},
      error: function(xhr,status,error) {
          $("#run-log").val($("#run-log").val()+"\n"+"failed to download detected photon data file: "+status);
      }
  });
}   

function updatestatus(data){
  let d = new Date();
  if(data.hasOwnProperty('status') && data.hasOwnProperty('dberror')){
      if(data.status === 'invalid' || data.status === 'killed'){
         $("#run-log").val($("#run-log").val()+"\n"+d.toLocaleTimeString()+" "+data.status+":"+data.dberror);
         resetjob();
         return;
      }else if(data.status === 'success'){
         $("#run").html("Cancel");
	 $('#run').unbind('click');
         $("#run").click(canceljob);
      }
  }
  jobid=data.jobid;
  if(jobid != null){
      $("#jobid").val(jobid);
      $("#jobhash").val(data.hash);
      $("#run-log").val($("#run-log").val()+"\n"+d.toLocaleTimeString()+" Successfully submitted job "+jobid);
      count=0;
      timer=setInterval(jobstatus,5000);
  }else
      $("#run-log").val($("#run-log").val()+"\n"+d.toLocaleTimeString()+' failed to submit, please try again');
}

function resetjob(){
    count=0;
    clearInterval(timer);
    $("#run").html("Submit");
    $('#run').unbind('click');
    $("#run").click(runsimulation);
}

function addlog(data){
  let d = new Date();
  if(data.hasOwnProperty('status')){
      if(data.hasOwnProperty('dberror'))
          $("#run-log").val($("#run-log").val()+"\n"+d.toLocaleTimeString()+" "+data.status+":"+data.dberror);
      else
          $("#run-log").val($("#run-log").val()+"\n"+d.toLocaleTimeString()+" "+data.status);
      if(data.status === 'invalid' || data.status === 'failed' || data.status === 'killed')
          resetjob();
  }
  if(data.hasOwnProperty('log')){
      lastlog=data.log.replace(/[\u001b\u009b][[()#;?]*(?:[0-9]{1,4}(?:;[0-9]{0,4})*)?[0-9A-ORZcf-nqry=><]/g, '').replace(/\n/g, "\n ");
      $("#run-log").val($("#run-log").val()+"\n"+d.toLocaleTimeString()+" log\n "+lastlog);
  }
  if(data.hasOwnProperty('output')){
      $("#run-log").val($("#run-log").val()+"\n"+d.toLocaleTimeString()+" "+"output data received");
      lastoutput=data.output;
      resetjob();
      if(!(lastoutput === ''))
          updatejsonlink("saveoutput", lastoutput, "output.json");
      let nii = JSON.parse(lastoutput);
      drawpreview(nii);
      lastjson = $("#output-textarea").val();
      $("#sharesubmit").prop( "disabled", false );
      $("#savedetphoton").attr( "disabled", !(data.hasOwnProperty('detphoton') && data.detphoton>0));
      if(data.hasOwnProperty('detphoton') && data.detphoton>0){
         $("#savedetphoton").attr("href","#");
         $("#savedetphoton").removeAttr("download");
         $("#savedetphoton").text("Click to Retrieve Detected Photon");
         $("#savedetphoton").click(getdetphoton);
      }
  }
}

function jobstatus() {
  if(count++>60 && timer != null){
      let d = new Date();
      $("#run-log").val($("#run-log").val()+"\n"+d.toLocaleTimeString()+" job expired");
      resetjob();
  }
  $.ajax({
      url: serverurl,
      data: { 'jobid': jobid, 'hash': $("#jobhash").val() },
      type: 'GET',
      crossOrigin: true,
      dataType: 'jsonp',
      jsonp: 'callback',
      jsonpCallback: 'addlog',
      success: function( data ){},
      error: function(xhr,status,error) {
          $("#run-log").val($("#run-log").val()+"\n"+"jobstatus error: "+status);
      }
  });
}

function canceljob() {
  $.ajax({
      url: serverurl,
      data: { 'jobid': jobid, 'action': 'cancel' },
      type: 'GET',
      crossOrigin: true,
      dataType: 'jsonp',
      success: function( data ){
          let d = new Date();
          resetjob();
	  $("#run-log").val($("#run-log").val()+"\n"+d.toLocaleTimeString()+" job canceled");
      },
      error: function(xhr,status,error) {
          $("#run-log").val($("#run-log").val()+"\n"+"canceljob error: "+status);
      }
  });
}

/* 
In this preview version of MCX Cloud, we initially set the below restrictions to 
ensure the smooth roll-out of this new service and help us testing the system.
We anticipate the gradual removal of these restrictions as the service is increasingly
tested. 

If you are building a private MCX Cloud, please disable the checklimit() call in the
runsimulation() function, as well as the checklimit() call in the mcxserver.cgi server
script.
*/

function checklimit(cfg) {
  if(cfg.Session.hasOwnProperty('Photons') && cfg.Session.Photons>5e8)
      throw new Error('the max photon number is limited to 5e8 in this preview version');
  else if(cfg.Session.hasOwnProperty('DebugFlag') && (cfg.Session.DebugFlag.includes('m')||cfg.Session.DebugFlag.includes('M')))
      throw new Error('storing photon trajectories is not supported in this preview version');
  else if(cfg.Forward.T1/cfg.Forward.Dt>100)
      throw new Error('the maximum time gate number is limited to 100 in this preview version');
  else if(cfg.Domain.hasOwnProperty('Dim') && cfg.Domain.Dim.length==3){
      cfg.Domain.Dim.map(function(x) {
         if(x>300)
	   throw new Error('the maximum domain dimension is 300 in this preview version');
      });
  }
  if(cfg.hasOwnProperty('Shapes') && cfg.Shapes.length>0){
      cfg.Shapes.map(function(x) {
         if(x.hasOwnProperty('Grid')){
	   x.Grid.Size.map(function(s) {
             if(s>300)
	       throw new Error('the maximum domain dimension is 300 in this preview version');
             });
	 }
      });
  }
  if(cfg.Domain.hasOwnProperty('Media') && cfg.Domain.Media.length>0){
      cfg.Domain.Media.map(function(o) {
         if(o.mus>50)
	   throw new Error('scattering coeff (mus) is limited to 50/mm in this preview version');
      });
  }
}

function runsimulation() {
  let fullname=$("#fullname").val();
  let email=$("#email").val();
  let inst=$("#inst").val();
  let netname=$("#netname").val();
  let json=$("#output-textarea").val();
  let isvalid=$("#validate-textarea").val();

  if(!(isvalid === 'valid'))
      throw "Input JSON is not valid according to the defined JSON schema";
  if(fullname === "" || email === "" || inst === "" || netname === "")
      throw "required fields are not provided, please type full name (private), email address (private), institute name (private) and net-name (public)";

  if(json !== lastloaded)
      checklimit(JSON.parse(json));

  setuserinfo();

  $.ajax({
      url: serverurl,
      data: { 'fullname': fullname, 'inst': inst, 'email': email, 'netname': netname, 'json': encodeURIComponent(json), 'callback':'-' },
      type: 'POST',
      crossOrigin: true,
      dataType: 'json',
      success: function( data ){
         updatestatus(data);
      },
      error: function(xhr,status,error) {
         $("#run-log").val($("#run-log").val()+"\n"+"runsimulation error: "+status);
      }
  });
}

function sharecomplete(data){
  alert("your simulation data have been recorded, thank you for sharing!");
}

function sharesimulation() {
  let fullname=$("#sfullname").val();
  let email=$("#semail").val();
  let inst=$("#sinst").val();
  let netname=$("#snetname").val();
  let comment=$("#sdescription").val();
  let json=$("#output-textarea").val();
  let title=$("#stitle").val();
  let license=$("input[name='slicense']:checked").val();
  let thumb=$("#thumbnail").prop('src');

  if(fullname === "" || email === "" || json === "" || comment==="" || title ==="" || license === undefined)
     throw "Required fields are not provided";

  $.ajax({
      url: serverurl,
      data: { 'fullname': fullname, 'inst': inst, 'email': email, 'netname': netname, 'json': encodeURIComponent(json), 
              'title': encodeURIComponent(title), 'comment': encodeURIComponent(comment), 
	      'thumbnail': encodeURIComponent(thumb), 'license': license, 'callback': '-' },
      type: 'POST',
      crossOrigin: true,
      dataType: 'json',
      success: function( data ){
         sharecomplete(data);
      },
      error: function(xhr,status,error) {
         alert("sharesimulation error: "+status);
      }
  });
}

  /* -------------------------------------------------------- 3d rendering functions */

function createbox(bsize, orig, tag){
      const geometry = new THREE.BoxGeometry(bsize[0],bsize[1],bsize[2]);
      geometry.translate(bsize[0]*0.5+orig[0],bsize[1]*0.5+orig[1],bsize[2]*0.5+orig[2]);
      const material = new THREE.MeshNormalMaterial( { transparent: true, opacity: 0.6, side:THREE.DoubleSide, wireframe: false, depthWrite :false } );
      const obj = new THREE.Mesh( geometry, material );
      return obj;
}

function createlayer(s, dim, tag){
      let bsize=bbxsize;
      bsize[dim]=Math.abs(s[0]-s[1]);
      let orig=[0,0,0];
      orig[dim]=Math.min(s[0],s[1]);
      return createbox(bsize, orig, tag);
}

function createdisk(R, orig, norm){
      const geometry = new THREE.CircleGeometry(R, 32);
      geometry.up=new THREE.Vector3(norm[0],norm[1],norm[2]);
      geometry.translate(orig[0],orig[1],orig[2]);
      const material = new THREE.MeshBasicMaterial( { color: 0xFFFF00, side:THREE.DoubleSide, wireframe: false, depthWrite :false } );
      const obj = new THREE.Mesh( geometry, material );
      return obj;
}

function createpoly(pos, norm){
      const geometry = new THREE.BufferGeometry().setFromPoints(pos);
      geometry.computeVertexNormals();
      const material = new THREE.MeshBasicMaterial( { color: 0xFFFF00, side:THREE.DoubleSide, wireframe: false, depthWrite :false } );
      const obj = new THREE.Mesh( geometry, material );
      return obj;
}

function resetscene(s){
      scene.remove.apply(scene, scene.children);
      const light = new THREE.AmbientLight( 0xffffff );
      light.position.set(s[0]*0.5,s[1]*0.5,s[2]*1.5);
      scene.add(light);
      camera.position.set(s[0]*2,s[1]*1.5,s[2]*1.5);
      camera.lookAt(new THREE.Vector3(s[0]*0.5,s[1]*0.5,s[2]*0.5));
      camera.zoom=0.7*Math.min($("#canvas").width()/(Math.sqrt(s[0]*s[0]+s[1]*s[1])), $("#canvas").height()/s[2]);
      camera.updateProjectionMatrix();
      camera.updateMatrix();
      
      let diag=Math.sqrt(s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);
      let distcenter=Math.sqrt(1.5*1.5*s[0]*s[0]+s[1]*s[1]+s[2]*s[2]);
      let near=distcenter-diag*0.6;
      let far =distcenter+diag*0.6;

      $("#camera-near").val(near);
      $("#camera-near").prop('min',near);
      $("#camera-near").prop('max',far);
 
      $("#camera-far").val(far);
      $("#camera-far").prop('min',near);
      $("#camera-far").prop('max',far);
}

function drawshape(shape,index){
  let keys = Object.keys(shape);
  let obj, c0, c1, dc, height, geometry, material;
  const dir={XLayers:0,YLayers:1,ZLayers:2,XSlabs:0,YSlabs:1,ZSlabs:2};

  switch(keys[0]){
    case "Grid":
      resetscene(shape.Grid.Size);
      boundingbox=createbox(shape.Grid.Size,[0,0,0],shape.Grid.Tag);
      const geo = new THREE.EdgesGeometry( boundingbox.geometry );
      const mat = new THREE.LineDashedMaterial( { color: 0xFFFF00, linewidth: 3, dashSize: 3, gapSize: 1 } );
      boundingbox = new THREE.LineSegments( geo, mat );
      boundingbox.computeLineDistances();
      scene.add( boundingbox );

      bbxsize=shape.Grid.Size;
      controls.target.set( shape.Grid.Size[0]*0.5, shape.Grid.Size[1]*0.5,shape.Grid.Size[2]*0.5);
      break;
    case "Box":
      boundingbox.add( createbox(shape.Box.Size,shape.Box.O,shape.Box.Tag) );
      break;
    case "Subgrid":
      boundingbox.add( createbox(shape.Subgrid.Size,shape.Subgrid.O,shape.Subgrid.Tag) );
      break;
    case "XLayers":
    case "YLayers":
    case "ZLayers":
      if(shape[keys[0]] != null)
         for (let i = 0; i < shape[keys[0]].length; i++)
            boundingbox.add( createlayer(shape[keys[0]][i], dir[keys[0]], shape[keys[0]][i][2]) );
      break;
    case "XSlabs":
    case "YSlabs":
    case "ZSlabs":
      if(shape[keys[0]] != null && shape[keys[0]].Bound != null){
         let slabs=shape[keys[0]].Bound;
	 if(slabs.length>0 && !Array.isArray(slabs[0]))
	     boundingbox.add(createlayer(slabs, dir[keys[0]]));
	 else
             for (let i = 0; i < slabs.length; i++)
                 boundingbox.add( createlayer(slabs[i], dir[keys[0]], shape[keys[0]].Tag ) );
      }
      break;
    case "Sphere":
      geometry = new THREE.SphereGeometry(shape.Sphere.R, 32,32);
      //geometry.applyMatrix4( new THREE.Matrix4().makeTranslation(shape.Sphere.O[0],shape.Sphere.O[1],shape.Sphere.O[2]) );
      material = new THREE.MeshBasicMaterial( { color: materialcolor[shape.Sphere.Tag], wireframe: true, transparent: true,  } );
      obj = new THREE.Mesh( geometry, material );
      obj.position.set(shape.Sphere.O[0],shape.Sphere.O[1],shape.Sphere.O[2]);
      boundingbox.add( obj );
      break;
    case "Cylinder":
      c0 = new THREE.Vector3( shape.Cylinder.C0[0],shape.Cylinder.C0[1],shape.Cylinder.C0[2] );
      c1 = new THREE.Vector3( shape.Cylinder.C1[0],shape.Cylinder.C1[1],shape.Cylinder.C1[2] );
      dc=c1;
      height= c0.distanceTo(c1);
      geometry = new THREE.CylinderGeometry(shape.Cylinder.R, shape.Cylinder.R, height, 32);
      geometry.translate( 0, height*0.5 - 1, 0 );
      geometry.rotateX( Math.PI*0.5 ); // orient along z-axis - required
      dc.sub(c0).normalize();
      geometry.lookAt( dc );
      geometry.translate((c0.x+c1.x), (c0.y+c1.y), (c0.z+c1.z))
      material = new THREE.MeshBasicMaterial( { color: materialcolor[shape.Cylinder.Tag], wireframe: true, transparent: false } );
      obj = new THREE.Mesh( geometry, material );
      boundingbox.add( obj );
      break;
  }
}

function drawsrc(obj){
  const dir = new THREE.Vector3( obj.Dir[0],obj.Dir[1],obj.Dir[2] );
  dir.normalize();
  const orig = new THREE.Vector3( obj.Pos[0],obj.Pos[1],obj.Pos[2] );
  let length = Math.max(bbxsize[0],bbxsize[1],bbxsize[2])*0.2, v1, v2;
  const hex = 0xFFFFFF;
  if(obj.hasOwnProperty('Param1') && obj.Param1.length>3)
      v1=new THREE.Vector3( obj.Param1[0], obj.Param1[1], obj.Param1[2] );

  const arrowHelper = new THREE.ArrowHelper( dir, orig, length, hex, 0.3*length, 0.15*length );
  arrowHelper.line.material.linewidth = length*0.2;
  boundingbox.add( arrowHelper );
  
  switch(obj.Type){
      case 'disk':
      case 'gaussian':
      case 'zgaussian':
         boundingbox.add( createdisk(obj.Param1[0], obj.Pos, obj.Dir) );
	 break;
      case 'planar':
      case 'fourier':
      case 'pattern':
         v2=new THREE.Vector3( obj.Param2[0], obj.Param2[1], obj.Param2[2] );
         boundingbox.add( createpoly([ orig, orig.clone().add(v1), orig.clone().add(v1).add(v2), 
	      orig.clone().add(v1).add(v2), orig.clone().add(v2), orig ], obj.Dir ) );
	 break;
      case 'fourierx':
      case 'fourierx2d':
         v2.cross(dir,v1).normalize().multiplyScalar(obj.Param1[3]);
         boundingbox.add( createpoly([ orig, orig.clone().add(v1), orig.clone().add(v1).add(v2), 
	      orig.clone().add(v1).add(v2), orig.clone().add(v2), orig ], obj.Dir ) );
	 break;
      case 'line':
      case 'slit':
         boundingbox.add( new THREE.ArrowHelper( v1.clone().normalize(), orig, v1.length(), hex, 0, 0 ) );
	 break;
  }
}

function drawdet(obj,index){
  const geometry = new THREE.SphereGeometry(obj.R, 32,32);
  geometry.applyMatrix4( new THREE.Matrix4().makeTranslation(obj.Pos[0],obj.Pos[1],obj.Pos[2]) );
  const material = new THREE.MeshBasicMaterial( { color: 0x00ff00, wireframe: true, transparent: false } );
  const det = new THREE.Mesh( geometry, material );
  boundingbox.add( det );
}

function isWebGL2Available (){
  try {
    let canvas = document.createElement( 'canvas' );
    return !! ( window.WebGL2RenderingContext && canvas.getContext( 'webgl2' ) );
  } catch ( e ) {
    return false;
  }
}

function render(){
  renderer.render( scene, camera );
}
		
function drawvolume(volume){
  const dtype={
    uint8:THREE.UnsignedByteType,
    uint16:THREE.UnsignedShortType,
    uint32:THREE.UnsignedIntType,
    int8:THREE.ByteType,
    int16:THREE.ShortType,
    int32:THREE.IntType,
    float32:THREE.FloatType
  };
  const dim=volume.shape;
  const buf=nj.array(volume.transpose().flatten().selection.data, 'float32');

  const texture = new THREE.DataTexture3D( buf.selection.data, dim[0], dim[1], dim[2]);
  texture.format = THREE.RedFormat;
  texture.type = THREE.FloatType;
  texture.minFilter = texture.magFilter = THREE.LinearFilter;
  texture.unpackAlignment = 1;
  texture.needsUpdate = true;

  // Colormap textures
  const cmtextures = {
	  viridis: new THREE.TextureLoader().load( 'https://threejs.org/examples/textures/cm_viridis.png', render ),
	  gray: new THREE.TextureLoader().load( 'https://threejs.org/examples/textures/cm_gray.png', render )
  };

  // Material
  const shader = document.getElementById('mip-radio-button').checked ? MipRenderShader : IsoRenderShader;

  const uniforms = THREE.UniformsUtils.clone( shader.uniforms );

  uniforms[ "u_data" ].value = texture;
  uniforms[ "u_size" ].value.set( dim[0], dim[1], dim[2] );
  uniforms[ "u_clim" ].value.set( volume.min(), volume.max() );
  uniforms[ "u_renderstyle" ].value = document.getElementById('mip-radio-button').checked ? 0 : 1;
  uniforms[ "u_renderthreshold" ].value =  0.2;
  uniforms[ "u_cmdata" ].value = cmtextures[ "viridis" ];
  uniforms[ "u_minslice" ].value.set( parseFloat($("#cross-x-low").val()), parseFloat($("#cross-y-low").val()), parseFloat($("#cross-z-low").val()) );
  uniforms[ "u_maxslice" ].value.set( parseFloat($("#cross-x-hi").val()), parseFloat($("#cross-y-hi").val()), parseFloat($("#cross-z-hi").val()) );

  lastclim=uniforms[ "u_clim" ].value;
  $("#clim-low").prop( "disabled", false );
  
  $("#clim-low").prop('min',lastclim.x);
  $("#clim-low").prop('max',lastclim.y);
  $("#clim-low").val(lastclim.x);

  $("#clim-hi").prop( "disabled", false );
  $("#clim-hi").prop('min',lastclim.x);
  $("#clim-hi").prop('max',lastclim.y);
  $("#clim-hi").val(lastclim.y);

  const material = new THREE.ShaderMaterial( {
	  uniforms: uniforms,
	  vertexShader: shader.vertexShader,
	  fragmentShader: shader.fragmentShader,
	  side: THREE.BackSide // The volume shader uses the backface as its "reference point"
  } );
  
  // THREE.Mesh
  const geometry = new THREE.BoxGeometry(dim[0], dim[1], dim[2]);
  geometry.translate(dim[0]*0.5, dim[1]*0.5, dim[2]*0.5 );

  const mesh = new THREE.Mesh( geometry, material );
  mesh.frustumCulled = false;

  return mesh;
}

function drawpreview(cfg){
  scene.remove.apply(scene, scene.children);
  if(cfg.hasOwnProperty('Shapes')){
    if(cfg.Shapes.constructor===Object && cfg.Shapes._ArraySize_ != null){
     let box={Grid: {Size: cfg.Shapes._ArraySize_}};
     drawshape(box,0);
     if(isWebGL2Available()){
       let jd=new jdata(cfg.Shapes,{});
       let vol=jd.decode().data;
       lastvolume=drawvolume(vol);
       boundingbox.add( lastvolume );
     }
    }else{
     if(cfg.Domain !=null && cfg.Domain.Dim!=null){
       let box={Grid: {Size: cfg.Domain.Dim}};
       drawshape(box,0);
     }
     if(cfg.Shapes != null && cfg.Shapes.length>0)
       cfg.Shapes.forEach(drawshape);
   }
   if(cfg.Optode != null){
    if(cfg.Optode.Source !=null)
      drawsrc(cfg.Optode.Source);
    if(cfg.Optode.Detector !=null && cfg.Optode.Detector.length>0)
      cfg.Optode.Detector.forEach(drawdet);
   }
  }else{
   if(cfg.hasOwnProperty('NIFTIData')){
     let box={Grid: {Size: cfg.NIFTIHeader.Dim}};
     drawshape(box,0);
     if(isWebGL2Available()){
       let jd=new jdata(cfg.NIFTIData,{});
       let vol=jd.decode().data;
       lastvolume=drawvolume(nj.log(nj.clip(vol, 1e-16, 1/0)) );
       boundingbox.add( lastvolume );
     }
   }
  }
  if(reqid === undefined) {
    requestAnimationFrame(update);
  }
}

function mulberry32(a) {
      let t = a += 0x6D2B79F5;
      t = Math.imul(t ^ t >>> 15, t | 1);
      t ^= t + Math.imul(t ^ t >>> 7, t | 61);
      return ((t ^ t >>> 14) >>> 0);
}

function updatejsonlink(linkid, text, name) {
  const a = document.getElementById(linkid);
  const type = name.split(".").pop();
  a.href = URL.createObjectURL( new Blob([text.replace(/\n/g, "\r\n")], { type:`text/${type === "txt" ? "plain" : type}` }) );
  a.download = name;
  $("#"+linkid).prop( "disabled", false );
}

function update() {
    reqid=requestAnimationFrame(update);
    if(renderer.updateComplete === undefined || !renderer.updateComplete) {
      renderer.render(scene, camera);
      renderer.updateComplete = true;
    }
    controls.update();
    stats.update();
}
function loadpubsimu(data){
  $("#output-textarea").val(data.json);
  if(data.hasOwnProperty('title'))
      $("#stitle").val(data.title);
  if(data.hasOwnProperty('comment'))
      $("#sdescription").val(data.comment);
  if(data.hasOwnProperty('license'))
      $("input[name='slicense']:checked").val(data.license);
  $("#setvalue").click();
  sleep(100).then(() => {
      lastloaded=$("#output-textarea").val();
      updatethumb(lastloaded, 300);
  });
}
function loadsimulib(key,time){
  if (confirm('Are you sure you want to replace the current simulation settings by the selected one?')) {
    $.ajax({
      url: serverurl,
      data: { 'id':time, 'hash': key, 'callback': 'loadpubsimu' },
      type: 'GET',
      crossOrigin: true,
      dataType: 'jsonp',
      jsonp: 'callback',
      jsonpCallback: 'loadpubsimu',
      success: function( data ){
      },
      error: function(xhr,status,error) {
         alert("loadsimulib error: "+status);
      }
    });
  }
}
function showsimudata(obj,time,lic){
  $("#simuinfo").show();
  $("#rpreview").html('<img src="'+$("#"+obj.id).prop('src')+'">');
  $("#rpreview").append("<button class='btn btn-primary btn-block' id='btloadsimu' onclick='loadsimulib(\""+obj.id+"\","+time+")'>Load</button>");
  $("#rtitle").html('<dt>Title</dt><dd>'+$("#"+obj.id).prop('title')+"</dd>");
  $("#rcomment").html('<dt>Comment</dt><dd>'+$("#"+obj.id).prop('alt')+"</dd>");
  $("#rlicense").html('<dt>License</dt><dd>'+lic+"</dd>");
}
function loadpubdata(data){
  for (let i = 0; i < data.length; i++) {
     let comment=data[i].comment.replace(/'/g,"`").replace(/\n +([^\n]*)\n/g,"<pre>$1</pre>").replace(/\n\*([^\n]+)/g,"<ul><li>$1</li></ul>").replace(/\n/g,'<br/>');
     comment=comment.replace(/(https?:\/\/)([^ \s<]+)/g,'<a target="_blank" href="$&">$1$2</a>');
     $("#mcxlibrary").append('<img class="simupreview" onclick="showsimudata(this,'+data[i].time+',\''+data[i].license+'\')" id="'+data[i].hash+
       '" src="'+data[i].thumbnail+'" title=\''+data[i].title.replace(/'/g,"`").replace(/\n/g,'<br/>')+'\' alt=\''+comment+'\'/>');
  }
  if(data.length==5){
    let offset=$("#mcxlibrary img").length;
    $("#mcxlibrary").append("<button class='btn btn-primary btn-block' id='btloadnext' onclick='searchpub("+offset+");this.remove()'>Load Next 5</button>");
    $("#btsearch").prop("disabled",true);
  }
}
function clearpub(){
  $("#mcxlibrary").html('');
  $("#rpreview").html('');
  $("#rtitle").html('');
  $("#rcomment").html('');
  $("#rlicense").html('');
  $("#btsearch").prop("disabled",false);
  $('#simuinfo').hide();
}
function searchpub(offset){
  let keyword=$("#keyword").val();
  $.ajax({
      url: serverurl,
      data: { 'keyword': keyword, 'limit': 5, 'offset': offset, 'callback': 'loadpubdata' },
      type: 'POST',
      crossOrigin: true,
      dataType: 'jsonp',
      jsonp: 'callback',
      jsonpCallback: 'loadpubdata',
      success: function( data ){
      },
      error: function(xhr,status,error) {
         alert("searchpub error: "+status);
      }
  });
}
function previewjsonfile(fname){
    $.get(fname, function(data) {
        drawpreview(JSON.parse(data));
    }, "text");
}

function createStats() {
  var stats = new Stats();
  stats.setMode(0);

  stats.domElement.style.position = 'relative';

  return stats;
}

// Fetch storage for the website.
function getstorage() {
  if (window.localStorage) {
     return window.localStorage;
  } else if (window.globalStorage) {
     var host = location.hostname || location.host || "localhost";
     return window.globalStorage[host]
  } else {
     return;
  }
}

function getuserinfo() {
  let storage = getstorage();
  if (!storage) return;
  if(storage.userinfo){
    let userinfo=JSON.parse(storage.userinfo);
    $("#fullname").val(userinfo.fullname);
    $("#inst").val(userinfo.inst);
    $("#email").val(userinfo.email);
    $("#netname").val(userinfo.netname);
  }
}

function setuserinfo() {
  let storage = getstorage();
  if (!storage) return;
  storage.userinfo = JSON.stringify({ fullname: $("#fullname").val(), inst: $("#inst").val(), email: $("#email").val(), netname: $("#netname").val()});
}

function setcrosssectionsizes() {
  if(lastvolume !== null){
    lastvolume.material.uniforms[ "u_minslice" ].value.set( parseFloat($("#cross-x-low").val()), parseFloat($("#cross-y-low").val()), parseFloat($("#cross-z-low").val()) );
    lastvolume.material.uniforms[ "u_maxslice" ].value.set( parseFloat($("#cross-x-hi").val()), parseFloat($("#cross-y-hi").val()), parseFloat($("#cross-z-hi").val()) );
    renderer.updateComplete = false;
  }
}

var canvas = $("#canvas");
var bbxsize=[0,0,0];

const scene = new THREE.Scene();

var boundingbox=scene;
var randseed=1648335518;
var lastlog='', lastoutput='';
var serverurl="https://kwafoo.coe.neu.edu/mcxcloud/mcxserver.cgi";

$('#drawlastinput').click(function () {
  if(lastjson !== ""){
      drawpreview(JSON.parse(lastjson));
  }
});

$('#drawlastoutput').click(function () {
  if(lastoutput !== ""){
      drawpreview(JSON.parse(lastoutput));
  }
});
$('#updatethumbnail').click(function () {
  updatethumb('', 300);
});

$("#credits").hide();
$('#run').unbind('click');
$("#run").click(runsimulation);
$("#sharesubmit").click(sharesimulation);
window.onerror = function(message) { alert(message); return true; }; 

// preventing page from redirecting
$("html").on("dragover", function(e) {
    e.preventDefault();
    e.stopPropagation();
});

$("html").on("drop", function(e) { e.preventDefault(); e.stopPropagation(); });

// Drag over
$('#canvas').on('dragover', function (e) {
    e.stopPropagation();
    e.preventDefault();
    $("#mcx1-preview h1").text("Drop to Plot");
});

// Drop
$('#canvas').on('drop', function (e) {
    e.stopPropagation();
    e.preventDefault();

    $("#mcx1-preview h1").text("Loading");

    var file = e.originalEvent.dataTransfer.files;
    previewjsonfile(file[0]);
    $("#mcx1-preview h1").text("Preview");
});

// default color for each label, 0,1,2,...
var materialcolor=[];
for(let i=0;i<256;i++){
    randseed=mulberry32(randseed);
    materialcolor.push(randseed);
}

//const camera = new THREE.PerspectiveCamera( 50, canvas.width()/canvas.height(), 1, 2000 );
const camera = new THREE.OrthographicCamera(canvas.width() / -2, canvas.width() / 2, canvas.height() / 2, canvas.height() / -2, 1, 1000);

camera.up = new THREE.Vector3(0,0,1);
camera.lookAt(new THREE.Vector3(0,0,0));
camera.updateProjectionMatrix();

const renderer = new THREE.WebGLRenderer({preserveDrawingBuffer: true});
renderer.setPixelRatio( window.devicePixelRatio );
renderer.setSize( canvas.width(), canvas.height());
//renderer.state.enable("logarithmicDepthBuffer");
canvas.append( renderer.domElement );

var controls = new THREE.OrbitControls(camera, renderer.domElement);
controls.minZoom = 0.5;
controls.maxZoom = 40;
controls.enableKeys=false;

controls.update();

function onPositionChange(o) {
  renderer.updateComplete = false;
}

controls.addEventListener('change', onPositionChange);

var stats = createStats();
document.getElementById('renderpanel').appendChild( stats.domElement );

var lastvolume=null;
var lastloaded=null;
var lastclim=0;
var reqid=undefined;

$("#clip-low").prop( "disabled", true );
$("#clip-hi").prop( "disabled", true );

getuserinfo();

$("#camera-near").on('change', function() {
    camera.near=parseFloat($(this).val());
    renderer.render(scene, camera);
    controls.update();
});
$("#camera-far").on('change', function() {
    camera.far=parseFloat($(this).val());
    renderer.render(scene, camera);
    controls.update();
});
$("#clim-low").on('input', function() {
    if(lastvolume !== null){
        let val=lastvolume.material.uniforms[ "u_clim" ].value;
        lastvolume.material.uniforms[ "u_clim" ].value.set( parseFloat($(this).val()), val.y );
        renderer.updateComplete = false;
    }
});
$("#clim-hi").on('input', function() {
    if(lastvolume !== null){
        let val=lastvolume.material.uniforms[ "u_clim" ].value;
        lastvolume.material.uniforms[ "u_clim" ].value.set( val.x, parseFloat($(this).val()) );
        renderer.updateComplete = false;
    }
});

$('#opensourcelib').click(function () {
  $("#credits").show();
});

$("#mip-radio-button").on('change', function() {
  if(lastvolume !== null){
    const unfs = lastvolume.material.uniforms;
    lastvolume.material = new THREE.ShaderMaterial( {
      uniforms: THREE.UniformsUtils.clone( MipRenderShader.uniforms ),
      vertexShader: MipRenderShader.vertexShader,
      fragmentShader: MipRenderShader.fragmentShader,
      side: THREE.BackSide
    } );
    lastvolume.material.uniforms = unfs;

    renderer.updateComplete = false;
  }
});

$("#iso-radio-button").on('change', function() {
  if(lastvolume !== null){
    const unfs = lastvolume.material.uniforms;
    lastvolume.material = new THREE.ShaderMaterial( {
      uniforms: THREE.UniformsUtils.clone( IsoRenderShader.uniforms ),
      vertexShader: IsoRenderShader.vertexShader,
      fragmentShader: IsoRenderShader.fragmentShader,
      side: THREE.BackSide
    } );
    lastvolume.material.uniforms = unfs;
    renderer.updateComplete = false;
  }
});

$("#cross-x-low").on('input', function() {
    setcrosssectionsizes();
});

$("#cross-y-low").on('input', function() {
    setcrosssectionsizes();
});

$("#cross-z-low").on('input', function() {
    setcrosssectionsizes();
});

$("#cross-x-hi").on('input', function() {
    setcrosssectionsizes();
});

$("#cross-y-hi").on('input', function() {
    setcrosssectionsizes();
});

$("#cross-z-hi").on('input', function() {
    setcrosssectionsizes();
});

function setControlAngles(polar, azimuth) {
  let mi = controls.minAzimuthAngle;
  let mx = controls.maxAzimuthAngle;
  let mip = controls.minPolarAngle;
  let mxp = controls.maxPolarAngle;
  controls.minAzimuthAngle = azimuth;
  controls.maxAzimuthAngle = azimuth;
  controls.minPolarAngle = polar;
  controls.maxPolarAngle = polar;
  controls.update();
  controls.minAzimuthAngle = mi;
  controls.maxAzimuthAngle = mx;
  controls.minPolarAngle = mip;
  controls.maxPolarAngle = mxp;
}

$("#pos-x-view").on('click', function() {
  setControlAngles(Math.PI * 90 / 180, Math.PI * 90 / 180);
});

$("#neg-x-view").on('click', function() {
  setControlAngles(Math.PI * 90 / 180, Math.PI * 270 / 180);
});

$("#pos-y-view").on('click', function() {
  setControlAngles(Math.PI * 90 / 180, Math.PI * 180 / 180);
});

$("#neg-y-view").on('click', function() {
  setControlAngles(Math.PI * 90 / 180, Math.PI * 0 / 180);
});

$("#pos-z-view").on('click', function() {
  setControlAngles(0, 0);
});

$("#neg-z-view").on('click', function() {
  setControlAngles(Math.PI * 180 / 180, 0);
});

  /* -------------------------------------------------------- main function */

$( document ).ready(function() {
  parseUrl();
});

</script>
</body>
</html>
